# ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุดูู ุฅุฏุงุฑุฉ ุงูููุธูููุ ุงูุฑูุงุชุจ ูุงููุณุชุญูุงุชุ ุงูุฅุฌุงุฒุงุชุ ุงูุชุฏุฑูุจุ ุชูููู ุงูุฃุฏุงุกุ ูุงูุตุญุฉ ูุงูุณูุงูุฉ ุงูููููุฉ.

### ุงููุตุฏุฑ ูู ุงูุชู ุฏู
- **ุงููููุฉ 29:** ูุธุงู ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ (150 ุณุงุนุฉ)
- **ุงููููุฉ 30:** ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุฏุงุก ูุงูุชูููู (125 ุณุงุนุฉ)
- **ุงููููุฉ 31:** ูุธุงู ุฅุฏุงุฑุฉ ุงูุตุญุฉ ูุงูุณูุงูุฉ ุงูููููุฉ (125 ุณุงุนุฉ)
- **ุฅุฌูุงูู ุงูุณุงุนุงุช:** 400 ุณุงุนุฉ

### ุงูุฃููููุฉ
โญโญ ูููุฉ

### ุงูุชุจุนูุงุช
- ุงููุธุงู ุงูุฃู (01) - ุดุฌุฑุฉ ุงูุญุณุงุจุงุช (ููุฑูุงุชุจ ูุงููุณุชุญูุงุช)
- ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ (04) - ุงููุฑู ูุงูุนุงูููู

---

## ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1. ุฅุฏุงุฑุฉ ุงูููุธููู (ุงููููุฉ 29.1)

#### 1.1 ุฌุฏูู ุงูููุธููู (employees)
```sql
CREATE TABLE employees (
    id UUID PRIMARY KEY,
    employee_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ
    first_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    last_name VARCHAR(100) NOT NULL,
    full_name_ar VARCHAR(200),
    full_name_en VARCHAR(200),
    
    -- ุงููููุฉ
    id_type VARCHAR(50), -- national_id, passport, residence
    id_number VARCHAR(50) NOT NULL,
    id_expiry_date DATE,
    
    nationality VARCHAR(50),
    gender VARCHAR(10), -- male, female
    date_of_birth DATE,
    place_of_birth VARCHAR(100),
    marital_status VARCHAR(20), -- single, married, divorced, widowed
    
    -- ูุนูููุงุช ุงูุงุชุตุงู
    phone VARCHAR(20),
    mobile VARCHAR(20) NOT NULL,
    email VARCHAR(100),
    personal_email VARCHAR(100),
    
    -- ุงูุนููุงู
    address TEXT,
    city VARCHAR(100),
    district VARCHAR(100),
    
    -- ุฌูุฉ ุงูุงุชุตุงู ูู ุงูุทูุงุฑุฆ
    emergency_contact_name VARCHAR(100),
    emergency_contact_phone VARCHAR(20),
    emergency_contact_relation VARCHAR(50),
    
    -- ุงูุตูุฑุฉ ูุงููุณุชูุฏุงุช
    photo_path VARCHAR(500),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'active', -- active, inactive, terminated, suspended
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.2 ุฌุฏูู ุจูุงูุงุช ุงูุชูุธูู (employment_details)
```sql
CREATE TABLE employment_details (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    
    -- ุงูุชุนููู
    hire_date DATE NOT NULL,
    probation_end_date DATE,
    contract_type VARCHAR(50), -- permanent, contract, temporary, part_time
    contract_start_date DATE,
    contract_end_date DATE,
    
    -- ุงููุธููุฉ
    job_title VARCHAR(100) NOT NULL,
    job_title_ar VARCHAR(100),
    department_id UUID REFERENCES departments(id),
    position_id UUID REFERENCES positions(id),
    
    -- ุงููุณุชูู ุงูุฅุฏุงุฑู
    manager_id UUID REFERENCES employees(id),
    is_manager BOOLEAN DEFAULT false,
    
    -- ุงููููุน
    work_location VARCHAR(100),
    station_id UUID, -- ุงููุญุทุฉ ุงููุนููุฉ
    
    -- ุณุงุนุงุช ุงูุนูู
    work_schedule VARCHAR(50), -- full_time, shift, flexible
    working_hours_per_week DECIMAL(5,2) DEFAULT 40,
    
    -- ุงูุญุงูุฉ
    employment_status VARCHAR(20) DEFAULT 'active', -- active, on_leave, suspended, terminated
    termination_date DATE,
    termination_reason TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.3 ุฌุฏูู ุงูุฃูุณุงู (departments)
```sql
CREATE TABLE departments (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    
    parent_id UUID REFERENCES departments(id),
    manager_id UUID REFERENCES employees(id),
    
    -- ุงูุฑุจุท ุงููุญุงุณุจู
    cost_center_id UUID REFERENCES cost_centers(id),
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.4 ุฌุฏูู ุงููุณููุงุช ุงููุธูููุฉ (positions)
```sql
CREATE TABLE positions (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    title VARCHAR(100) NOT NULL,
    title_ar VARCHAR(100),
    
    department_id UUID REFERENCES departments(id),
    
    -- ุงููุณุชูู
    grade_id UUID REFERENCES salary_grades(id),
    level INTEGER, -- ุงููุณุชูู ุงููุธููู
    
    -- ุงููุตู
    description TEXT,
    responsibilities TEXT,
    requirements TEXT,
    
    -- ุงูุนุฏุฏ ุงููุณููุญ
    headcount INTEGER DEFAULT 1,
    current_count INTEGER DEFAULT 0,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 2. ุงูุฑูุงุชุจ ูุงููุณุชุญูุงุช (ุงููููุฉ 29.2)

#### 2.1 ุฌุฏูู ุณูู ุงูุฑูุงุชุจ (salary_grades)
```sql
CREATE TABLE salary_grades (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    
    min_salary DECIMAL(15,2),
    max_salary DECIMAL(15,2),
    
    -- ุงูุจุฏูุงุช ุงูุงูุชุฑุงุถูุฉ
    housing_allowance_pct DECIMAL(5,2) DEFAULT 0,
    transport_allowance DECIMAL(15,2) DEFAULT 0,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.2 ุฌุฏูู ุจูุงูุงุช ุงูุฑุงุชุจ (salary_details)
```sql
CREATE TABLE salary_details (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    
    -- ุงูุฑุงุชุจ ุงูุฃุณุงุณู
    basic_salary DECIMAL(15,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'YER',
    
    -- ุงูุจุฏูุงุช
    housing_allowance DECIMAL(15,2) DEFAULT 0,
    transport_allowance DECIMAL(15,2) DEFAULT 0,
    food_allowance DECIMAL(15,2) DEFAULT 0,
    phone_allowance DECIMAL(15,2) DEFAULT 0,
    other_allowances DECIMAL(15,2) DEFAULT 0,
    
    -- ุฅุฌูุงูู ุงูุฑุงุชุจ
    gross_salary DECIMAL(15,2) GENERATED ALWAYS AS (
        basic_salary + housing_allowance + transport_allowance + 
        food_allowance + phone_allowance + other_allowances
    ) STORED,
    
    -- ุงูุฎุตููุงุช ุงูุซุงุจุชุฉ
    social_insurance DECIMAL(15,2) DEFAULT 0,
    tax_deduction DECIMAL(15,2) DEFAULT 0,
    
    -- ุทุฑููุฉ ุงูุฏูุน
    payment_method VARCHAR(50), -- bank_transfer, cash, check
    bank_name VARCHAR(100),
    bank_account VARCHAR(50),
    iban VARCHAR(50),
    
    effective_from DATE NOT NULL,
    effective_to DATE,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.3 ุฌุฏูู ูุณูุฑุงุช ุงูุฑูุงุชุจ (payroll_runs)
```sql
CREATE TABLE payroll_runs (
    id UUID PRIMARY KEY,
    payroll_number VARCHAR(50) UNIQUE NOT NULL,
    
    period_year INTEGER NOT NULL,
    period_month INTEGER NOT NULL,
    
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    payment_date DATE,
    
    -- ุงูุฅุฌูุงููุงุช
    total_employees INTEGER,
    total_gross DECIMAL(15,2),
    total_deductions DECIMAL(15,2),
    total_net DECIMAL(15,2),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'draft', -- draft, calculated, approved, paid, cancelled
    
    calculated_at TIMESTAMP,
    calculated_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    approved_by UUID REFERENCES users(id),
    paid_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.4 ุฌุฏูู ุชูุงุตูู ุงูุฑูุงุชุจ (payroll_details)
```sql
CREATE TABLE payroll_details (
    id UUID PRIMARY KEY,
    payroll_id UUID REFERENCES payroll_runs(id),
    employee_id UUID REFERENCES employees(id),
    
    -- ุฃูุงู ุงูุนูู
    working_days INTEGER,
    actual_days INTEGER,
    absent_days INTEGER DEFAULT 0,
    
    -- ุงูุฑุงุชุจ ุงูุฃุณุงุณู
    basic_salary DECIMAL(15,2),
    
    -- ุงูุจุฏูุงุช
    housing_allowance DECIMAL(15,2) DEFAULT 0,
    transport_allowance DECIMAL(15,2) DEFAULT 0,
    food_allowance DECIMAL(15,2) DEFAULT 0,
    other_allowances DECIMAL(15,2) DEFAULT 0,
    
    -- ุงูุฅุถุงูุงุช
    overtime_hours DECIMAL(10,2) DEFAULT 0,
    overtime_amount DECIMAL(15,2) DEFAULT 0,
    bonus DECIMAL(15,2) DEFAULT 0,
    commission DECIMAL(15,2) DEFAULT 0,
    
    -- ุฅุฌูุงูู ุงูุงุณุชุญูุงูุงุช
    total_earnings DECIMAL(15,2),
    
    -- ุงูุฎุตููุงุช
    absence_deduction DECIMAL(15,2) DEFAULT 0,
    late_deduction DECIMAL(15,2) DEFAULT 0,
    loan_deduction DECIMAL(15,2) DEFAULT 0,
    advance_deduction DECIMAL(15,2) DEFAULT 0,
    social_insurance DECIMAL(15,2) DEFAULT 0,
    tax_deduction DECIMAL(15,2) DEFAULT 0,
    other_deductions DECIMAL(15,2) DEFAULT 0,
    
    -- ุฅุฌูุงูู ุงูุฎุตููุงุช
    total_deductions DECIMAL(15,2),
    
    -- ุตุงูู ุงูุฑุงุชุจ
    net_salary DECIMAL(15,2),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, paid
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.5 ุฌุฏูู ุงูุณูู ูุงููุฑูุถ (employee_loans)
```sql
CREATE TABLE employee_loans (
    id UUID PRIMARY KEY,
    loan_number VARCHAR(50) UNIQUE NOT NULL,
    
    employee_id UUID REFERENCES employees(id),
    
    loan_type VARCHAR(50), -- advance, loan, emergency
    
    amount DECIMAL(15,2) NOT NULL,
    interest_rate DECIMAL(5,2) DEFAULT 0,
    total_amount DECIMAL(15,2),
    
    -- ุงูุณุฏุงุฏ
    installment_amount DECIMAL(15,2),
    number_of_installments INTEGER,
    paid_amount DECIMAL(15,2) DEFAULT 0,
    remaining_amount DECIMAL(15,2),
    
    start_date DATE NOT NULL,
    end_date DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, active, completed, cancelled
    
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 3. ุงูุฅุฌุงุฒุงุช ูุงูุบูุงุจ (ุงููููุฉ 29.3)

#### 3.1 ุฌุฏูู ุฃููุงุน ุงูุฅุฌุงุฒุงุช (leave_types)
```sql
CREATE TABLE leave_types (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    
    -- ุงูุฑุตูุฏ ุงูุณููู
    annual_balance INTEGER, -- ุนุฏุฏ ุงูุฃูุงู
    
    -- ุงูุฅุนุฏุงุฏุงุช
    is_paid BOOLEAN DEFAULT true,
    requires_approval BOOLEAN DEFAULT true,
    requires_attachment BOOLEAN DEFAULT false,
    can_carry_forward BOOLEAN DEFAULT false,
    max_carry_forward INTEGER DEFAULT 0,
    
    -- ุงูุญุฏ ุงูุฃุฏูู ูุงูุฃูุตู
    min_days INTEGER DEFAULT 1,
    max_days INTEGER,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3.2 ุฌุฏูู ุฃุฑุตุฏุฉ ุงูุฅุฌุงุฒุงุช (leave_balances)
```sql
CREATE TABLE leave_balances (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    leave_type_id UUID REFERENCES leave_types(id),
    
    year INTEGER NOT NULL,
    
    opening_balance DECIMAL(5,2) DEFAULT 0,
    accrued DECIMAL(5,2) DEFAULT 0,
    taken DECIMAL(5,2) DEFAULT 0,
    pending DECIMAL(5,2) DEFAULT 0,
    remaining DECIMAL(5,2),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, leave_type_id, year)
);
```

#### 3.3 ุฌุฏูู ุทูุจุงุช ุงูุฅุฌุงุฒุงุช (leave_requests)
```sql
CREATE TABLE leave_requests (
    id UUID PRIMARY KEY,
    request_number VARCHAR(50) UNIQUE NOT NULL,
    
    employee_id UUID REFERENCES employees(id),
    leave_type_id UUID REFERENCES leave_types(id),
    
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    days DECIMAL(5,2) NOT NULL,
    
    reason TEXT,
    attachment_path VARCHAR(500),
    
    -- ุงูุจุฏูู
    substitute_id UUID REFERENCES employees(id),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, cancelled
    
    -- ุงูููุงููุงุช
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    rejection_reason TEXT,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3.4 ุฌุฏูู ุงูุญุถูุฑ ูุงูุงูุตุฑุงู (attendance)
```sql
CREATE TABLE attendance (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    
    attendance_date DATE NOT NULL,
    
    -- ุงูุญุถูุฑ
    check_in_time TIME,
    check_in_location VARCHAR(100),
    check_in_method VARCHAR(50), -- fingerprint, card, manual, mobile
    
    -- ุงูุงูุตุฑุงู
    check_out_time TIME,
    check_out_location VARCHAR(100),
    check_out_method VARCHAR(50),
    
    -- ุงูุญุณุงุจ
    working_hours DECIMAL(5,2),
    overtime_hours DECIMAL(5,2) DEFAULT 0,
    late_minutes INTEGER DEFAULT 0,
    early_leave_minutes INTEGER DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20), -- present, absent, leave, holiday, weekend
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, attendance_date)
);
```

---

### 4. ุงูุชุฏุฑูุจ ูุงูุชุทููุฑ (ุงููููุฉ 29.4)

#### 4.1 ุฌุฏูู ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ (training_courses)
```sql
CREATE TABLE training_courses (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(200) NOT NULL,
    name_ar VARCHAR(200),
    
    category VARCHAR(100), -- technical, soft_skills, safety, management
    
    description TEXT,
    objectives TEXT,
    
    -- ุงููุฏุฉ
    duration_hours INTEGER,
    duration_days INTEGER,
    
    -- ุงููุฏุฑุจ
    trainer_type VARCHAR(50), -- internal, external
    trainer_name VARCHAR(100),
    trainer_organization VARCHAR(100),
    
    -- ุงูุชูููุฉ
    cost_per_person DECIMAL(15,2),
    
    is_mandatory BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.2 ุฌุฏูู ุฌูุณุงุช ุงูุชุฏุฑูุจ (training_sessions)
```sql
CREATE TABLE training_sessions (
    id UUID PRIMARY KEY,
    session_number VARCHAR(50) UNIQUE NOT NULL,
    
    course_id UUID REFERENCES training_courses(id),
    
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    
    location VARCHAR(200),
    max_participants INTEGER,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'planned', -- planned, ongoing, completed, cancelled
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.3 ุฌุฏูู ุงููุดุงุฑููู ูู ุงูุชุฏุฑูุจ (training_participants)
```sql
CREATE TABLE training_participants (
    id UUID PRIMARY KEY,
    session_id UUID REFERENCES training_sessions(id),
    employee_id UUID REFERENCES employees(id),
    
    registration_date DATE,
    
    -- ุงูุญุถูุฑ
    attended BOOLEAN DEFAULT false,
    attendance_percentage DECIMAL(5,2),
    
    -- ุงููุชูุฌุฉ
    passed BOOLEAN,
    score DECIMAL(5,2),
    certificate_issued BOOLEAN DEFAULT false,
    certificate_date DATE,
    
    feedback TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(session_id, employee_id)
);
```

---

### 5. ุชูููู ุงูุฃุฏุงุก (ุงููููุฉ 30)

#### 5.1 ุฌุฏูู ุฏูุฑุงุช ุงูุชูููู (evaluation_cycles)
```sql
CREATE TABLE evaluation_cycles (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    
    cycle_type VARCHAR(50), -- annual, semi_annual, quarterly
    
    year INTEGER NOT NULL,
    period VARCHAR(20), -- Q1, Q2, Q3, Q4, H1, H2, full_year
    
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    
    -- ูุฑุงุญู ุงูุชูููู
    self_evaluation_start DATE,
    self_evaluation_end DATE,
    manager_evaluation_start DATE,
    manager_evaluation_end DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'draft', -- draft, active, closed
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.2 ุฌุฏูู ูุนุงููุฑ ุงูุชูููู (evaluation_criteria)
```sql
CREATE TABLE evaluation_criteria (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    
    category VARCHAR(50), -- performance, competency, behavior
    
    description TEXT,
    
    weight DECIMAL(5,2) DEFAULT 1, -- ุงููุฒู
    max_score DECIMAL(5,2) DEFAULT 5,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.3 ุฌุฏูู ุชููููุงุช ุงูููุธููู (employee_evaluations)
```sql
CREATE TABLE employee_evaluations (
    id UUID PRIMARY KEY,
    evaluation_number VARCHAR(50) UNIQUE NOT NULL,
    
    cycle_id UUID REFERENCES evaluation_cycles(id),
    employee_id UUID REFERENCES employees(id),
    evaluator_id UUID REFERENCES employees(id),
    
    -- ุงูุชูููู ุงูุฐุงุชู
    self_evaluation_date TIMESTAMP,
    self_evaluation_score DECIMAL(5,2),
    self_evaluation_comments TEXT,
    
    -- ุชูููู ุงููุฏูุฑ
    manager_evaluation_date TIMESTAMP,
    manager_evaluation_score DECIMAL(5,2),
    manager_evaluation_comments TEXT,
    
    -- ุงููุชูุฌุฉ ุงูููุงุฆูุฉ
    final_score DECIMAL(5,2),
    rating VARCHAR(20), -- excellent, very_good, good, satisfactory, poor
    
    -- ุงูุฃูุฏุงู
    goals_achieved INTEGER,
    goals_total INTEGER,
    
    -- ุงูุชูุตูุงุช
    recommendations TEXT,
    development_plan TEXT,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, self_completed, manager_completed, finalized
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.4 ุฌุฏูู ุชูุงุตูู ุงูุชูููู (evaluation_details)
```sql
CREATE TABLE evaluation_details (
    id UUID PRIMARY KEY,
    evaluation_id UUID REFERENCES employee_evaluations(id),
    criteria_id UUID REFERENCES evaluation_criteria(id),
    
    self_score DECIMAL(5,2),
    self_comments TEXT,
    
    manager_score DECIMAL(5,2),
    manager_comments TEXT,
    
    final_score DECIMAL(5,2),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.5 ุฌุฏูู ุงูุฃูุฏุงู (employee_goals)
```sql
CREATE TABLE employee_goals (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    cycle_id UUID REFERENCES evaluation_cycles(id),
    
    title VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- ุงูููุงุณ
    target_value DECIMAL(15,2),
    actual_value DECIMAL(15,2),
    unit VARCHAR(50),
    
    weight DECIMAL(5,2) DEFAULT 1,
    
    start_date DATE,
    due_date DATE,
    completed_date DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, in_progress, completed, cancelled
    achievement_percentage DECIMAL(5,2),
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 6. ุงูุญูุงูุฒ ูุงูููุงูุขุช (ุงููููุฉ 30.3)

#### 6.1 ุฌุฏูู ุฃููุงุน ุงูุญูุงูุฒ (incentive_types)
```sql
CREATE TABLE incentive_types (
    id UUID PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    
    category VARCHAR(50), -- bonus, commission, reward, recognition
    
    -- ุงููููุฉ
    value_type VARCHAR(20), -- fixed, percentage
    default_value DECIMAL(15,2),
    
    -- ุงูุดุฑูุท
    requires_approval BOOLEAN DEFAULT true,
    
    -- ุงูุฑุจุท ุงููุญุงุณุจู
    account_id UUID REFERENCES accounts(id),
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 6.2 ุฌุฏูู ุงูุญูุงูุฒ ูุงูููุงูุขุช (employee_incentives)
```sql
CREATE TABLE employee_incentives (
    id UUID PRIMARY KEY,
    incentive_number VARCHAR(50) UNIQUE NOT NULL,
    
    employee_id UUID REFERENCES employees(id),
    incentive_type_id UUID REFERENCES incentive_types(id),
    
    amount DECIMAL(15,2) NOT NULL,
    
    reason TEXT,
    reference_type VARCHAR(50), -- evaluation, project, achievement
    reference_id UUID,
    
    effective_date DATE NOT NULL,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, paid, cancelled
    
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    -- ุงูุฏูุน
    payroll_id UUID REFERENCES payroll_runs(id),
    paid_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

### 7. ุงูุตุญุฉ ูุงูุณูุงูุฉ ุงูููููุฉ (ุงููููุฉ 31)

#### 7.1 ุฌุฏูู ุงูุญูุงุฏุซ (incidents)
```sql
CREATE TABLE incidents (
    id UUID PRIMARY KEY,
    incident_number VARCHAR(50) UNIQUE NOT NULL,
    
    incident_type VARCHAR(50), -- injury, near_miss, property_damage, environmental
    severity VARCHAR(20), -- minor, moderate, major, critical
    
    incident_date TIMESTAMP NOT NULL,
    reported_date TIMESTAMP NOT NULL,
    
    location VARCHAR(200),
    station_id UUID,
    
    description TEXT NOT NULL,
    
    -- ุงููุชุถุฑุฑูู
    affected_employees TEXT, -- JSON array of employee IDs
    injuries_description TEXT,
    
    -- ุงูุดููุฏ
    witnesses TEXT,
    
    -- ุงูุชุญููู
    investigation_status VARCHAR(20) DEFAULT 'pending', -- pending, in_progress, completed
    investigation_findings TEXT,
    root_cause TEXT,
    
    -- ุงูุฅุฌุฑุงุกุงุช
    immediate_actions TEXT,
    corrective_actions TEXT,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'reported', -- reported, investigating, resolved, closed
    
    reported_by UUID REFERENCES users(id),
    investigated_by UUID REFERENCES users(id),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 7.2 ุฌุฏูู ุงููุฎุงุทุฑ (hazards)
```sql
CREATE TABLE hazards (
    id UUID PRIMARY KEY,
    hazard_number VARCHAR(50) UNIQUE NOT NULL,
    
    hazard_type VARCHAR(50), -- physical, chemical, biological, ergonomic, psychological
    
    title VARCHAR(200) NOT NULL,
    description TEXT,
    
    location VARCHAR(200),
    station_id UUID,
    
    -- ุงูุชูููู
    likelihood VARCHAR(20), -- rare, unlikely, possible, likely, certain
    consequence VARCHAR(20), -- insignificant, minor, moderate, major, catastrophic
    risk_level VARCHAR(20), -- low, medium, high, extreme
    
    -- ุงูุถูุงุจุท
    existing_controls TEXT,
    additional_controls TEXT,
    
    -- ุงููุณุคูููุฉ
    responsible_person UUID REFERENCES employees(id),
    review_date DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'identified', -- identified, assessed, controlled, closed
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 7.3 ุฌุฏูู ุงููุญูุตุงุช ุงูุทุจูุฉ (medical_examinations)
```sql
CREATE TABLE medical_examinations (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    
    examination_type VARCHAR(50), -- pre_employment, periodic, return_to_work, special
    
    examination_date DATE NOT NULL,
    next_examination_date DATE,
    
    provider VARCHAR(200),
    
    -- ุงููุชุงุฆุฌ
    result VARCHAR(20), -- fit, fit_with_restrictions, unfit, pending
    restrictions TEXT,
    
    -- ุงููุฑููุงุช
    report_path VARCHAR(500),
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 7.4 ุฌุฏูู ุชุฏุฑูุจุงุช ุงูุณูุงูุฉ (safety_trainings)
```sql
CREATE TABLE safety_trainings (
    id UUID PRIMARY KEY,
    employee_id UUID REFERENCES employees(id),
    
    training_type VARCHAR(100), -- fire_safety, first_aid, electrical_safety, ppe
    
    training_date DATE NOT NULL,
    expiry_date DATE,
    
    provider VARCHAR(200),
    
    -- ุงูุดูุงุฏุฉ
    certificate_number VARCHAR(100),
    certificate_path VARCHAR(500),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'valid', -- valid, expiring_soon, expired
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ุงูุฑุจุท ุงููุญุงุณุจู

### ุงูุญุณุงุจุงุช ุงููุฑุชุจุทุฉ
| ุงูุญุณุงุจ | ุงูุฑูุฒ | ุงูุงุณุชุฎุฏุงู |
|--------|-------|-----------|
| ูุตุฑููุงุช ุงูุฑูุงุชุจ | 510 | ุงูุฑูุงุชุจ ุงูุฃุณุงุณูุฉ |
| ูุตุฑููุงุช ุงูุจุฏูุงุช | 511 | ุจุฏูุงุช ุงูุณูู ูุงูููู |
| ูุตุฑููุงุช ุงูููุงูุขุช | 512 | ุงูุญูุงูุฒ ูุงูููุงูุขุช |
| ูุตุฑููุงุช ุงูุชุฏุฑูุจ | 513 | ุชูุงููู ุงูุชุฏุฑูุจ |
| ูุณุชุญูุงุช ุงูููุธููู | 210 | ุงูุฑูุงุชุจ ุงููุณุชุญูุฉ |
| ุณูู ุงูููุธููู | 114 | ุงูุณูู ูุงููุฑูุถ |
| ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ | 211 | ุญุตุฉ ุงูุดุฑูุฉ ูุงูููุธู |

### ุงููููุฏ ุงููุญุงุณุจูุฉ

#### ุนูุฏ ุงุญุชุณุงุจ ุงูุฑูุงุชุจ:
```
ูู ุญู/ ูุตุฑููุงุช ุงูุฑูุงุชุจ (510)
ูู ุญู/ ูุตุฑููุงุช ุงูุจุฏูุงุช (511)
    ุฅูู ุญู/ ูุณุชุญูุงุช ุงูููุธููู (210)
    ุฅูู ุญู/ ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ (211)
    ุฅูู ุญู/ ุณูู ุงูููุธููู (114) - ุฎุตู ุงููุณุท
```

#### ุนูุฏ ุตุฑู ุงูุฑูุงุชุจ:
```
ูู ุญู/ ูุณุชุญูุงุช ุงูููุธููู (210)
    ุฅูู ุญู/ ุงูุจูู/ุงูุตูุฏูู
```

#### ุนูุฏ ุตุฑู ุณููุฉ:
```
ูู ุญู/ ุณูู ุงูููุธููู (114)
    ุฅูู ุญู/ ุงูุจูู/ุงูุตูุฏูู
```

#### ุนูุฏ ุตุฑู ููุงูุฃุฉ:
```
ูู ุญู/ ูุตุฑููุงุช ุงูููุงูุขุช (512)
    ุฅูู ุญู/ ุงูุจูู/ุงูุตูุฏูู
```

---

## ุงูู APIs

### ุฅุฏุงุฑุฉ ุงูููุธููู
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/employees | ูุงุฆูุฉ ุงูููุธููู |
| GET | /api/v1/employees/:id | ุชูุงุตูู ุงูููุธู |
| POST | /api/v1/employees | ุฅุถุงูุฉ ููุธู |
| PUT | /api/v1/employees/:id | ุชุนุฏูู ููุธู |
| GET | /api/v1/employees/:id/profile | ููู ุงูููุธู ุงููุงูู |
| GET | /api/v1/departments | ูุงุฆูุฉ ุงูุฃูุณุงู |
| GET | /api/v1/positions | ูุงุฆูุฉ ุงููุณููุงุช ุงููุธูููุฉ |

### ุงูุฑูุงุชุจ
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/payroll | ูุงุฆูุฉ ูุณูุฑุงุช ุงูุฑูุงุชุจ |
| POST | /api/v1/payroll | ุฅูุดุงุก ูุณูุฑ ุฑูุงุชุจ |
| POST | /api/v1/payroll/:id/calculate | ุญุณุงุจ ุงูุฑูุงุชุจ |
| POST | /api/v1/payroll/:id/approve | ุงุนุชูุงุฏ ุงููุณูุฑ |
| GET | /api/v1/payroll/:id/details | ุชูุงุตูู ุงููุณูุฑ |
| GET | /api/v1/employees/:id/payslip/:month | ูุณููุฉ ุงูุฑุงุชุจ |

### ุงูุฅุฌุงุฒุงุช
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/leave-requests | ูุงุฆูุฉ ุทูุจุงุช ุงูุฅุฌุงุฒุงุช |
| POST | /api/v1/leave-requests | ุชูุฏูู ุทูุจ ุฅุฌุงุฒุฉ |
| PUT | /api/v1/leave-requests/:id/approve | ุงูููุงููุฉ ุนูู ุงูุทูุจ |
| PUT | /api/v1/leave-requests/:id/reject | ุฑูุถ ุงูุทูุจ |
| GET | /api/v1/employees/:id/leave-balance | ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช |

### ุงูุญุถูุฑ
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | /api/v1/attendance/check-in | ุชุณุฌูู ุงูุญุถูุฑ |
| POST | /api/v1/attendance/check-out | ุชุณุฌูู ุงูุงูุตุฑุงู |
| GET | /api/v1/attendance/daily | ุชูุฑูุฑ ุงูุญุถูุฑ ุงููููู |
| GET | /api/v1/employees/:id/attendance | ุณุฌู ุญุถูุฑ ุงูููุธู |

### ุงูุชูููู
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/evaluations | ูุงุฆูุฉ ุงูุชููููุงุช |
| POST | /api/v1/evaluations | ุฅูุดุงุก ุชูููู |
| PUT | /api/v1/evaluations/:id | ุชุญุฏูุซ ุงูุชูููู |
| GET | /api/v1/employees/:id/evaluations | ุชููููุงุช ุงูููุธู |

---

## ุงูุดุงุดุงุช

### ุดุงุดุงุช ุงูููุธููู
1. ูุงุฆูุฉ ุงูููุธููู
2. ููู ุงูููุธู (ุงูุจูุงูุงุช ุงููุงููุฉ)
3. ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ููุธู
4. ุงููููู ุงูุชูุธููู
5. ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ูุงููุณููุงุช

### ุดุงุดุงุช ุงูุฑูุงุชุจ
6. ูุณูุฑุงุช ุงูุฑูุงุชุจ
7. ุฅูุดุงุก ูุณูุฑ ุฌุฏูุฏ
8. ุชูุงุตูู ุงููุณูุฑ
9. ูุณููุฉ ุงูุฑุงุชุจ
10. ุฅุฏุงุฑุฉ ุงูุณูู ูุงููุฑูุถ
11. ุณูู ุงูุฑูุงุชุจ

### ุดุงุดุงุช ุงูุฅุฌุงุฒุงุช
12. ุทูุจุงุช ุงูุฅุฌุงุฒุงุช
13. ูููุฐุฌ ุทูุจ ุฅุฌุงุฒุฉ
14. ุฃุฑุตุฏุฉ ุงูุฅุฌุงุฒุงุช
15. ุชูููู ุงูุฅุฌุงุฒุงุช

### ุดุงุดุงุช ุงูุญุถูุฑ
16. ุชุณุฌูู ุงูุญุถูุฑ/ุงูุงูุตุฑุงู
17. ุชูุฑูุฑ ุงูุญุถูุฑ ุงููููู
18. ุชูุฑูุฑ ุงูุญุถูุฑ ุงูุดูุฑู

### ุดุงุดุงุช ุงูุชูููู
19. ุฏูุฑุงุช ุงูุชูููู
20. ูููุฐุฌ ุงูุชูููู
21. ุชูุงุฑูุฑ ุงูุฃุฏุงุก
22. ุฅุฏุงุฑุฉ ุงูุฃูุฏุงู

### ุดุงุดุงุช ุงูุณูุงูุฉ
23. ุชุณุฌูู ุงูุญูุงุฏุซ
24. ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ
25. ุงููุญูุตุงุช ุงูุทุจูุฉ
26. ุชุฏุฑูุจุงุช ุงูุณูุงูุฉ

---

## ุงูุฌุฏูู ุงูุฒููู

| ุงููุฑุญูุฉ | ุงูููุงู | ุงูุณุงุนุงุช | ุงูุฃุณุงุจูุน |
|---------|--------|---------|----------|
| 1 | ุฅุฏุงุฑุฉ ุงูููุธููู ูุงูุฃูุณุงู | 50 | 1.25 |
| 2 | ุงูุฑูุงุชุจ ูุงููุณุชุญูุงุช | 60 | 1.5 |
| 3 | ุงูุฅุฌุงุฒุงุช ูุงูุบูุงุจ | 40 | 1 |
| 4 | ุงูุญุถูุฑ ูุงูุงูุตุฑุงู | 30 | 0.75 |
| 5 | ุงูุชุฏุฑูุจ ูุงูุชุทููุฑ | 30 | 0.75 |
| 6 | ุชูููู ุงูุฃุฏุงุก | 60 | 1.5 |
| 7 | ุงูุญูุงูุฒ ูุงูููุงูุขุช | 30 | 0.75 |
| 8 | ุงูุตุญุฉ ูุงูุณูุงูุฉ | 60 | 1.5 |
| 9 | ุงูุชูุงุฑูุฑ ูุงูุงุฎุชุจุงุฑ | 40 | 1 |
| **ุงูุฅุฌูุงูู** | | **400** | **10** |

---

## ุงูุฑุจุท ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

| ุงููุธุงู | ููุน ุงูุฑุจุท | ุงููุตู |
|--------|-----------|-------|
| ุงููุธุงู ุงูุฃู (01) | ูุญุงุณุจู | ุดุฌุฑุฉ ุงูุญุณุงุจุงุชุ ุงููููุฏ |
| ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ (04) | ุชุดุบููู | ุงููุฑู ูุงูุนุงูููู ุงูููุฏุงูููู |
| ูุธุงู ุงูุฃุตูู ูุงูุตูุงูุฉ (05) | ุชุดุบููู | ุงูููููู ูุงูููุงูููู |


---

## ูุธุงู ุญูุงูุฒ ุงูููููู (Technician Incentive System)

> **ุงูุบุฑุถ:** ุญุณุงุจ ููุงูุขุช ุงูููููู ุจูุงุกู ุนูู ุงูุฎุฏูุงุช ุงูููุฌุฒุฉ ูู ูุชุงููุฌ ุงูุฎุฏูุงุช

### ุฌุฏูู ุญูุงูุฒ ุงูููููู ุงูุดูุฑูุฉ (technician_monthly_incentives)

```sql
CREATE TABLE technician_monthly_incentives (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    technician_id UUID REFERENCES employees(id),
    
    -- ุงููุชุฑุฉ
    year INT NOT NULL,
    month INT NOT NULL,
    
    -- ุฅุญุตุงุฆูุงุช ุงูุฅูุฌุงุฒ
    total_work_orders INT DEFAULT 0,
    completed_work_orders INT DEFAULT 0,
    on_time_completion INT DEFAULT 0,
    
    -- ุงูุฃุฌูุฑ ุงููุณุชุญูุฉ
    total_service_fees DECIMAL(12, 2) DEFAULT 0,
    bonus_amount DECIMAL(12, 2) DEFAULT 0,
    deductions DECIMAL(12, 2) DEFAULT 0,
    net_incentive DECIMAL(12, 2) DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'approved', 'paid'
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    paid_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(technician_id, year, month)
);
```

### ุฌุฏูู ุชูุงุตูู ุญูุงูุฒ ุงูููู (technician_incentive_details)

```sql
CREATE TABLE technician_incentive_details (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    incentive_id UUID REFERENCES technician_monthly_incentives(id),
    
    work_order_id UUID REFERENCES field_operations(id),
    service_id UUID REFERENCES service_catalog(id),
    
    service_name VARCHAR(100),
    quantity DECIMAL(10, 2),
    fee_per_unit DECIMAL(12, 2),
    total_fee DECIMAL(12, 2),
    
    executed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### ุดุงุดุฉ ุชูุฑูุฑ ุญูุงูุฒ ุงูููููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุชูุฑูุฑ ุญูุงูุฒ ุงูููููู - ุฏูุณูุจุฑ 2025                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุงููุชุฑุฉ: [ุฏูุณูุจุฑ 2025 โผ]  ุงููุญุทุฉ: [ุงููู โผ]  ุงูุญุงูุฉ: [ุงููู โผ]       โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโ โ
โ  โ ุงูููู      โ ุฃูุงูุฑ    โ ููุชููุฉ   โ ุงูุฃุฌูุฑ   โ ุงูููุงูุฃุฉ โ ุงูุตุงููโ โ
โ  โโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโค โ
โ  โ ุฃุญูุฏ ูุญูุฏ  โ 45       โ 43       โ 85,000   โ 5,000    โ90,000 โ โ
โ  โ ุนูู ุญุณู   โ 38       โ 36       โ 72,000   โ 3,000    โ75,000 โ โ
โ  โ ูุญูุฏ ุนุจุฏุงูููโ 52       โ 50       โ 98,000   โ 8,000    โ106,000โ โ
โ  โโโโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโ โ
โ                                                                     โ
โ  ุฅุฌูุงูู ุงูุฃุฌูุฑ: 255,000 ุฑูุงู | ุฅุฌูุงูู ุงูููุงูุขุช: 16,000 ุฑูุงู         โ
โ                                                                     โ
โ  [ุงุนุชูุงุฏ ุงููู]  [ุชุตุฏูุฑ Excel]  [ุทุจุงุนุฉ]                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### APIs ูุธุงู ุงูุญูุงูุฒ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/incentives/technicians` | ูุงุฆูุฉ ุญูุงูุฒ ุงูููููู |
| GET | `/api/v1/incentives/technicians/:id` | ุชูุงุตูู ุญูุงูุฒ ููู |
| POST | `/api/v1/incentives/calculate/:year/:month` | ุญุณุงุจ ุงูุญูุงูุฒ ุงูุดูุฑูุฉ |
| PUT | `/api/v1/incentives/:id/approve` | ุงุนุชูุงุฏ ุงูุญูุงูุฒ |
| PUT | `/api/v1/incentives/:id/pay` | ุชุณุฌูู ุงูุตุฑู |
| GET | `/api/v1/incentives/report/:year/:month` | ุชูุฑูุฑ ุงูุญูุงูุฒ ุงูุดูุฑู |


---

# 8. ุทูุจุงุช ุงูุนูุฏ ููููุธููู (Employee Custody Requests)

> **ุงูุบุฑุถ:** ุชูููู ุงูููุธููู ูู ุทูุจ ุงูุนูุฏ ุงููุงููุฉ ูุงููุงุฏูุฉ ุนุจุฑ ูุธุงู ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ

## 8.1 ุฃููุงุน ุทูุจุงุช ุงูุนูุฏ

| ุงูููุน | ุงููุตู | ุงูููุงููุฉ | ุงููุธุงู ุงููุฑุชุจุท |
|-------|-------|----------|----------------|
| **ุนูุฏุฉ ุณูุฑ** | ูุตุงุฑูู ุฑุญูุฉ ุนูู | ุงููุฏูุฑ ุงููุจุงุดุฑ + ุงููุงููุฉ | ุงููุธุงู ุงูุฃู (01) |
| **ุนูุฏุฉ ูุซุฑูุฉ** | ูุตุงุฑูู ุงูููุชุจ | ุงููุฏูุฑ ุงููุจุงุดุฑ | ุงููุธุงู ุงูุฃู (01) |
| **ุนูุฏุฉ ูุดุชุฑูุงุช** | ุดุฑุงุก ุทุงุฑุฆ | ุงููุฏูุฑ + ุงููุดุชุฑูุงุช | ุงููุธุงู ุงูุฃู (01) |
| **ุณููุฉ ุฑุงุชุจ** | ุณููุฉ ุนูู ุงูุฑุงุชุจ | HR + ุงููุงููุฉ | ุงููุธุงู ุงูุฃู (01) |
| **ุนูุฏุฉ ุฃุฏูุงุช** | ุฃุฏูุงุช ุนูู | ุงููุฏูุฑ ุงููุจุงุดุฑ | ุงููุฎุฒูู (06) |
| **ุนูุฏุฉ ูุนุฏุงุช** | ูุงุจุชูุจุ ูุงุชู | IT + ุงููุฏูุฑ | ุงูุฃุตูู (03) |

## 8.2 ุฌุฏูู ุทูุจุงุช ุงูุนูุฏ (custody_requests)

```sql
CREATE TABLE custody_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id) NOT NULL,
    
    -- ุฑูู ุงูุทูุจ
    request_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ููุน ุงูุนูุฏุฉ
    custody_category VARCHAR(20) NOT NULL, -- 'financial', 'material', 'asset'
    custody_type VARCHAR(30) NOT NULL,
    
    -- ููุฏู ุงูุทูุจ
    employee_id UUID REFERENCES employees(id) NOT NULL,
    employee_name VARCHAR(200),
    department_id UUID REFERENCES departments(id),
    
    -- ุงูุชูุงุตูู
    purpose TEXT NOT NULL,
    amount DECIMAL(15, 2), -- ููุนูุฏ ุงููุงููุฉ
    items JSONB, -- ููุนูุฏ ุงููุงุฏูุฉ
    
    -- ุงูุชูุงุฑูุฎ
    request_date DATE NOT NULL DEFAULT CURRENT_DATE,
    needed_by_date DATE,
    expected_return_date DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending',
    -- 'draft': ูุณูุฏุฉ
    -- 'pending': ุจุงูุชุธุงุฑ ุงูููุงููุฉ
    -- 'approved': ููุงูู ุนูููุง
    -- 'rejected': ูุฑููุถุฉ
    -- 'issued': ูุตุฑููุฉ
    -- 'cancelled': ููุบุงุฉ
    
    -- ุงูููุงููุงุช
    current_approval_step INTEGER DEFAULT 1,
    
    -- ุงููุฑููุงุช
    attachments JSONB DEFAULT '[]',
    
    -- ุงูููุงุญุธุงุช
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุฌุฏูู ุฎุทูุงุช ุงูููุงููุฉ
CREATE TABLE custody_request_approvals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    request_id UUID REFERENCES custody_requests(id) NOT NULL,
    
    step_number INTEGER NOT NULL,
    approver_type VARCHAR(30) NOT NULL, -- 'direct_manager', 'hr', 'finance', 'it', 'procurement'
    approver_id UUID REFERENCES users(id),
    
    status VARCHAR(20) DEFAULT 'pending',
    -- 'pending': ุจุงูุชุธุงุฑ
    -- 'approved': ููุงูู
    -- 'rejected': ูุฑููุถ
    
    decision_date TIMESTAMP,
    comments TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 8.3 ุดุงุดุฉ ุทูุจ ุนูุฏุฉ (ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ผ ุทูุจ ุนูุฏุฉ ุฌุฏูุฏุฉ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                 โ
โ  โโ ููุน ุงูุนูุฏุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                                                                           โ  โ
โ  โ  ๐ฐ ุนูุฏ ูุงููุฉ                        ๐ฆ ุนูุฏ ูุงุฏูุฉ                        โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ  โ
โ  โ  โ โ ุนูุฏุฉ ุณูุฑ                 โ    โ โ ุฃุฏูุงุช ุนูู               โ      โ  โ
โ  โ  โ โ ุนูุฏุฉ ูุซุฑูุฉ               โ    โ โ ูุนุฏุงุช (ูุงุจุชูุจ/ูุงุชู)     โ      โ  โ
โ  โ  โ โ ุนูุฏุฉ ูุดุชุฑูุงุช             โ    โ โ ููุงุฏ ุงุณุชููุงููุฉ          โ      โ  โ
โ  โ  โ โ ุณููุฉ ุฑุงุชุจ                โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  โโ ุชูุงุตูู ุงูุทูุจ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงููุจูุบ ุงููุทููุจ: [2,000          ] ุฑูุงู                                    โ  โ
โ  โ ุงูุบุฑุถ: [ูุตุงุฑูู ููุชุจูุฉ - ูุฑุทุงุณูุฉ ููุณุชูุฒูุงุช                              ]  โ  โ
โ  โ ุชุงุฑูุฎ ุงูุญุงุฌุฉ: [20/12/2025]                                                โ  โ
โ  โ ุชุงุฑูุฎ ุงูุชุตููุฉ ุงููุชููุน: [31/12/2025]                                       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  โโ ูุณุงุฑ ุงูููุงููุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ 1. ุงููุฏูุฑ ุงููุจุงุดุฑ: ุฃุญูุฏ ูุญูุฏ                                              โ  โ
โ  โ 2. ุงููุงููุฉ: ูุณู ุงููุงููุฉ                                                   โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  [ุฅุฑุณุงู ุงูุทูุจ]  [ุญูุธ ููุณูุฏุฉ]  [ุฅูุบุงุก]                                          โ
โ                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 8.4 ุดุงุดุฉ ูุชุงุจุนุฉ ุทูุจุงุช ุงูุนูุฏ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ุทูุจุงุช ุงูุนูุฏ ุงูุฎุงุตุฉ ุจู                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                 โ
โ  [ูู ุงูุทูุจุงุช] [ุจุงูุชุธุงุฑ ุงูููุงููุฉ] [ูุตุฑููุฉ] [ุจุงูุชุธุงุฑ ุงูุชุตููุฉ]                    โ
โ                                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ # โ ุงูุฑูู      โ ุงูููุน      โ ุงููุจูุบ   โ ุงูุญุงูุฉ           โ ุงูุชุงุฑูุฎ     โ  โ
โ  โ 1 โ CR-001    โ ุนูุฏุฉ ุณูุฑ   โ 5,000   โ ๐ข ูุตุฑููุฉ        โ 10/12/2025 โ  โ
โ  โ 2 โ CR-002    โ ุนูุฏุฉ ูุซุฑูุฉ โ 2,000   โ ๐ก ุจุงูุชุธุงุฑ ุงูููุงููุฉโ 15/12/2025 โ  โ
โ  โ 3 โ CR-003    โ ุณููุฉ ุฑุงุชุจ  โ 3,000   โ ๐ด ูุฑููุถุฉ        โ 12/12/2025 โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  โโ ุชูุงุตูู ุงูุทูุจ CR-001 โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงูููุน: ุนูุฏุฉ ุณูุฑ                                                           โ  โ
โ  โ ุงููุจูุบ: 5,000 ุฑูุงู                                                        โ  โ
โ  โ ุงูุบุฑุถ: ุฒูุงุฑุฉ ุนูู ููุฑุน ุฌุฏุฉ                                                 โ  โ
โ  โ                                                                           โ  โ
โ  โ ูุณุงุฑ ุงูููุงููุฉ:                                                            โ  โ
โ  โ โ ุงููุฏูุฑ ุงููุจุงุดุฑ - ููุงูู (11/12/2025)                                    โ  โ
โ  โ โ ุงููุงููุฉ - ููุงูู (12/12/2025)                                           โ  โ
โ  โ โ ุงูุตุฑู - ุชู (13/12/2025)                                                โ  โ
โ  โ                                                                           โ  โ
โ  โ โ๏ธ ููุนุฏ ุงูุชุตููุฉ: 25/12/2025 (ูุชุจูู 10 ุฃูุงู)                              โ  โ
โ  โ                                                                           โ  โ
โ  โ [ุชุตููุฉ ุงูุนูุฏุฉ]                                                            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 8.5 ุชูุฑูุฑ ุนูุฏ ุงูููุธููู

```sql
CREATE VIEW v_employee_custodies_summary AS
SELECT 
    e.id AS employee_id,
    e.full_name,
    e.department_name,
    
    -- ุงูุนูุฏ ุงููุงููุฉ
    COUNT(DISTINCT fc.id) FILTER (WHERE fc.status IN ('issued', 'pending_settlement')) AS open_financial_custodies,
    COALESCE(SUM(fc.approved_amount) FILTER (WHERE fc.status IN ('issued', 'pending_settlement')), 0) AS total_financial_custody,
    
    -- ุงูุนูุฏ ุงููุงุฏูุฉ
    COUNT(DISTINCT mc.id) FILTER (WHERE mc.status IN ('active', 'partial_return')) AS open_material_custodies,
    COALESCE(SUM(mc.total_value - mc.returned_value) FILTER (WHERE mc.status IN ('active', 'partial_return')), 0) AS total_material_custody,
    
    -- ุงููุชุฃุฎุฑุฉ
    COUNT(*) FILTER (WHERE fc.expected_settlement_date < CURRENT_DATE AND fc.status = 'issued') AS overdue_financial,
    COUNT(*) FILTER (WHERE mc.expected_return_date < CURRENT_DATE AND mc.status = 'active') AS overdue_material
    
FROM employees e
LEFT JOIN financial_custodies fc ON fc.employee_id = e.id
LEFT JOIN material_custodies mc ON mc.custodian_id = e.id AND mc.custodian_type = 'employee'
GROUP BY e.id, e.full_name, e.department_name;
```

## 8.6 APIs ุทูุจุงุช ุงูุนูุฏ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/self-service/custody-requests` | ุทูุจุงุช ุงูููุธู |
| POST | `/api/v1/self-service/custody-requests` | ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ |
| GET | `/api/v1/self-service/custody-requests/:id` | ุชูุงุตูู ุทูุจ |
| DELETE | `/api/v1/self-service/custody-requests/:id` | ุฅูุบุงุก ุทูุจ |
| GET | `/api/v1/self-service/my-custodies` | ุนูุฏู ุงูุญุงููุฉ |
| POST | `/api/v1/self-service/custodies/:id/settle` | ุชุตููุฉ ุนูุฏุฉ |
| GET | `/api/v1/manager/custody-requests` | ุทูุจุงุช ููููุงููุฉ |
| POST | `/api/v1/manager/custody-requests/:id/approve` | ุงูููุงููุฉ |
| POST | `/api/v1/manager/custody-requests/:id/reject` | ุงูุฑูุถ |

---

# 6. ูุญุฏุฉ ุงูุญุถูุฑ ูุงูุงูุตุฑุงู (Attendance Management)

## 6.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุฏูุฌ ุจูุงูุงุช ุฃุฌูุฒุฉ ุงูุจุตูุฉ ุงูููุฒุนุฉ ูู ุงููุญุทุงุช ุนุจุฑ ุงูุดุจูุฉ ุงูุฎุงุตุฉุ ูุฃุชูุชุฉ ุญุณุงุจ ุณุงุนุงุช ุงูุนููุ ูุฑุจุทูุง ุจูุธุงู ุงูุฑูุงุชุจ.

### ุงููุฒุงูุง ุงูุฑุฆูุณูุฉ

1. **ูุฑูุฒูุฉ ุงูุจูุงูุงุช:** ุฌููุน ุจูุงูุงุช ุงูุจุตูุฉ ุชุชุฏูู ุชููุงุฆูุงู ููุฎุงุฏู ุงููุฑูุฒู
2. **ุฃุชูุชุฉ ุงูุญุณุงุจุงุช:** ุญุณุงุจ ุงูุชุฃุฎูุฑ ูุงูุนูู ุงูุฅุถุงูู ุชููุงุฆูุงู
3. **ุชูุงูู ุงูุฑูุงุชุจ:** ุชุตุฏูุฑ ูุจุงุดุฑ ููุธุงู ุงูุฑูุงุชุจ
4. **ุฑุคูุฉ ููุฑูุฉ:** ููุญุฉ ุชุญูู ูููุฏูุฑูู ุจุญุงูุฉ ุงูุชูุงุฌุฏ

## 6.2 ุฌุฏูู ุฌุฏุงูู ุงูุนูู (work_schedules)

```sql
CREATE TABLE work_schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ูุนูููุงุช ุงูุฌุฏูู
    schedule_name VARCHAR(200) NOT NULL,
    schedule_code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    
    -- ููุน ุงูุฌุฏูู
    schedule_type ENUM(
        'fixed',              -- ุซุงุจุช (8 ุต - 4 ู)
        'shift',              -- ูุฑุฏูุงุช
        'flexible',           -- ูุฑู
        'ramadan'             -- ุฑูุถุงู
    ) NOT NULL,
    
    -- ุฃููุงุช ุงูุนูู (ููุฌุฏูู ุงูุซุงุจุช)
    work_start_time TIME,
    work_end_time TIME,
    break_start_time TIME,
    break_end_time TIME,
    
    -- ุฃูุงู ุงูุนูู
    working_days VARCHAR(20) DEFAULT '0,1,2,3,4',  -- ุงูุฃุญุฏ ููุฎููุณ
    
    -- ูุชุฑุฉ ุงูุณูุงุญ
    late_grace_minutes INT DEFAULT 15,            -- ูุชุฑุฉ ุณูุงุญ ููุชุฃุฎูุฑ
    early_leave_grace_minutes INT DEFAULT 15,     -- ูุชุฑุฉ ุณูุงุญ ููุงูุตุฑุงู ุงููุจูุฑ
    
    -- ุงูุนูู ุงูุฅุถุงูู
    overtime_threshold_minutes INT DEFAULT 30,    -- ุงูุญุฏ ุงูุฃุฏูู ููุนูู ุงูุฅุถุงูู
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT true,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ุฌุฏุงูู ุงูุนูู ุงูุงูุชุฑุงุถูุฉ
INSERT INTO work_schedules (schedule_name, schedule_code, schedule_type, work_start_time, work_end_time, break_start_time, break_end_time) VALUES
('ุงูุฏูุงู ุงูุฑุณูู', 'OFFICIAL', 'fixed', '08:00', '16:00', '12:00', '13:00'),
('ูุฑุฏูุฉ ุงูุตุจุงุญ', 'SHIFT_MORNING', 'shift', '06:00', '14:00', NULL, NULL),
('ูุฑุฏูุฉ ุงููุณุงุก', 'SHIFT_EVENING', 'shift', '14:00', '22:00', NULL, NULL),
('ูุฑุฏูุฉ ุงูููู', 'SHIFT_NIGHT', 'shift', '22:00', '06:00', NULL, NULL),
('ุฏูุงู ุฑูุถุงู', 'RAMADAN', 'ramadan', '09:00', '14:00', NULL, NULL);
```

## 6.3 ุฌุฏูู ุชุนููู ุฌุฏุงูู ุงูุนูู ููููุธููู (employee_schedules)

```sql
CREATE TABLE employee_schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    schedule_id UUID NOT NULL REFERENCES work_schedules(id),
    
    -- ูุชุฑุฉ ุงูุณุฑูุงู
    effective_from DATE NOT NULL,
    effective_to DATE,                            -- NULL = ุณุงุฑู ุญุชู ุฅุดุนุงุฑ ุขุฎุฑ
    
    -- ุงูุญุงูุฉ
    is_current BOOLEAN DEFAULT true,
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, effective_from)
);

CREATE INDEX idx_employee_schedules_emp ON employee_schedules(employee_id);
CREATE INDEX idx_employee_schedules_current ON employee_schedules(is_current) WHERE is_current = true;
```

## 6.4 ุฌุฏูู ุฃุฌูุฒุฉ ุงูุจุตูุฉ (biometric_devices)

```sql
CREATE TABLE biometric_devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    asset_id UUID REFERENCES assets(id),          -- ุฑุจุท ุจูุธุงู ุงูุฃุตูู
    
    -- ูุนูููุงุช ุงูุฌูุงุฒ
    device_code VARCHAR(50) UNIQUE NOT NULL,
    device_name VARCHAR(200) NOT NULL,
    device_type ENUM('fingerprint', 'face', 'card', 'mixed') NOT NULL,
    manufacturer VARCHAR(100),
    model VARCHAR(100),
    serial_number VARCHAR(100),
    
    -- ุงููููุน
    station_id UUID NOT NULL REFERENCES stations(id),
    location_description VARCHAR(500),
    
    -- ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู
    ip_address VARCHAR(45),
    port INT DEFAULT 4370,
    connection_type ENUM('network', 'wifi', 'usb') DEFAULT 'network',
    
    -- ุญุงูุฉ ุงูุงุชุตุงู
    is_online BOOLEAN DEFAULT false,
    last_sync_at TIMESTAMP,
    last_heartbeat_at TIMESTAMP,
    
    -- ุงูุญุงูุฉ
    status ENUM('active', 'inactive', 'maintenance') DEFAULT 'active',
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_biometric_devices_station ON biometric_devices(station_id);
CREATE INDEX idx_biometric_devices_status ON biometric_devices(status);
```

## 6.5 ุฌุฏูู ุณุฌู ุงูุจุตูุงุช ุงูุฎุงู (raw_attendance_log)

```sql
CREATE TABLE raw_attendance_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ูุตุฏุฑ ุงูุจูุงูุงุช
    device_id UUID NOT NULL REFERENCES biometric_devices(id),
    
    -- ุจูุงูุงุช ุงูุจุตูุฉ
    employee_code VARCHAR(50) NOT NULL,           -- ุฑูู ุงูููุธู ูู ุฌูุงุฒ ุงูุจุตูุฉ
    punch_time TIMESTAMP NOT NULL,
    punch_type ENUM('in', 'out', 'unknown') DEFAULT 'unknown',
    
    -- ุจูุงูุงุช ุฅุถุงููุฉ ูู ุงูุฌูุงุฒ
    verification_type ENUM('fingerprint', 'face', 'card', 'password') DEFAULT 'fingerprint',
    device_log_id VARCHAR(100),                   -- ูุนุฑู ุงูุณุฌู ูู ุงูุฌูุงุฒ
    
    -- ูุนุงูุฌุฉ ุงูุจูุงูุงุช
    is_processed BOOLEAN DEFAULT false,
    processed_at TIMESTAMP,
    matched_employee_id UUID REFERENCES employees(id),
    
    -- ุงุณุชูุงู ุงูุจูุงูุงุช
    received_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(device_id, device_log_id)
);

CREATE INDEX idx_raw_attendance_time ON raw_attendance_log(punch_time);
CREATE INDEX idx_raw_attendance_employee ON raw_attendance_log(employee_code);
CREATE INDEX idx_raw_attendance_unprocessed ON raw_attendance_log(is_processed) WHERE is_processed = false;
```

## 6.6 ุฌุฏูู ุณุฌู ุงูุฏูุงู ุงููููู (daily_attendance)

```sql
CREATE TABLE daily_attendance (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    attendance_date DATE NOT NULL,
    
    -- ุฃููุงุช ุงูุญุถูุฑ ูุงูุงูุตุฑุงู
    first_punch_in TIMESTAMP,
    last_punch_out TIMESTAMP,
    
    -- ุงูุฌุฏูู ุงููุทุจู
    schedule_id UUID REFERENCES work_schedules(id),
    expected_start TIME,
    expected_end TIME,
    
    -- ุงูุญุณุงุจุงุช
    actual_work_minutes INT DEFAULT 0,
    expected_work_minutes INT DEFAULT 0,
    late_minutes INT DEFAULT 0,
    early_leave_minutes INT DEFAULT 0,
    overtime_minutes INT DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'present',            -- ุญุงุถุฑ
        'absent',             -- ุบุงุฆุจ
        'late',               -- ูุชุฃุฎุฑ
        'early_leave',        -- ุงูุตุฑุงู ูุจูุฑ
        'half_day',           -- ูุตู ููู
        'leave',              -- ุฅุฌุงุฒุฉ
        'holiday',            -- ุนุทูุฉ ุฑุณููุฉ
        'weekend',            -- ุนุทูุฉ ุฃุณุจูุนูุฉ
        'business_trip'       -- ูููุฉ ุนูู
    ) DEFAULT 'absent',
    
    -- ููุงุญุธุงุช
    notes TEXT,
    
    -- ุงูุชุฏููู
    is_manually_adjusted BOOLEAN DEFAULT false,
    adjusted_by UUID REFERENCES users(id),
    adjusted_at TIMESTAMP,
    adjustment_reason TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, attendance_date)
);

CREATE INDEX idx_daily_attendance_date ON daily_attendance(attendance_date);
CREATE INDEX idx_daily_attendance_employee ON daily_attendance(employee_id);
CREATE INDEX idx_daily_attendance_status ON daily_attendance(status);
```

## 6.7 ูุญุฑู ูุนุงูุฌุฉ ุงูุญุถูุฑ

```sql
CREATE OR REPLACE FUNCTION process_daily_attendance(p_date DATE DEFAULT CURRENT_DATE - 1)
RETURNS TABLE (
    processed_count INT,
    error_count INT,
    errors JSONB
) AS $$
DECLARE
    v_employee RECORD;
    v_schedule RECORD;
    v_first_in TIMESTAMP;
    v_last_out TIMESTAMP;
    v_late_minutes INT;
    v_early_leave_minutes INT;
    v_overtime_minutes INT;
    v_actual_minutes INT;
    v_expected_minutes INT;
    v_status VARCHAR(20);
    v_processed INT := 0;
    v_errors INT := 0;
    v_error_list JSONB := '[]'::JSONB;
BEGIN
    -- ูุนุงูุฌุฉ ูู ููุธู
    FOR v_employee IN 
        SELECT e.id, e.employee_code, es.schedule_id
        FROM employees e
        LEFT JOIN employee_schedules es ON es.employee_id = e.id AND es.is_current = true
        WHERE e.status = 'active'
    LOOP
        BEGIN
            -- ุงูุญุตูู ุนูู ุฌุฏูู ุงูุนูู
            SELECT * INTO v_schedule
            FROM work_schedules
            WHERE id = v_employee.schedule_id;
            
            -- ุงูุญุตูู ุนูู ุฃูู ุญุถูุฑ ูุขุฎุฑ ุงูุตุฑุงู
            SELECT 
                MIN(CASE WHEN punch_type IN ('in', 'unknown') THEN punch_time END),
                MAX(CASE WHEN punch_type IN ('out', 'unknown') THEN punch_time END)
            INTO v_first_in, v_last_out
            FROM raw_attendance_log
            WHERE matched_employee_id = v_employee.id
            AND DATE(punch_time) = p_date;
            
            -- ุญุณุงุจ ุงูุฏูุงุฆู ุงููุชููุนุฉ
            v_expected_minutes := EXTRACT(EPOCH FROM (v_schedule.work_end_time - v_schedule.work_start_time)) / 60;
            IF v_schedule.break_start_time IS NOT NULL THEN
                v_expected_minutes := v_expected_minutes - 
                    EXTRACT(EPOCH FROM (v_schedule.break_end_time - v_schedule.break_start_time)) / 60;
            END IF;
            
            -- ุชุญุฏูุฏ ุงูุญุงูุฉ ูุงูุญุณุงุจุงุช
            IF v_first_in IS NULL THEN
                -- ุบูุงุจ
                v_status := 'absent';
                v_late_minutes := 0;
                v_early_leave_minutes := 0;
                v_overtime_minutes := 0;
                v_actual_minutes := 0;
            ELSE
                -- ุญุณุงุจ ุงูุชุฃุฎูุฑ
                v_late_minutes := GREATEST(0, 
                    EXTRACT(EPOCH FROM (v_first_in::TIME - v_schedule.work_start_time)) / 60 
                    - v_schedule.late_grace_minutes
                );
                
                -- ุญุณุงุจ ุงูุงูุตุฑุงู ุงููุจูุฑ
                IF v_last_out IS NOT NULL THEN
                    v_early_leave_minutes := GREATEST(0,
                        EXTRACT(EPOCH FROM (v_schedule.work_end_time - v_last_out::TIME)) / 60
                        - v_schedule.early_leave_grace_minutes
                    );
                    
                    -- ุญุณุงุจ ุงูุนูู ุงูุฅุถุงูู
                    v_overtime_minutes := GREATEST(0,
                        EXTRACT(EPOCH FROM (v_last_out::TIME - v_schedule.work_end_time)) / 60
                        - v_schedule.overtime_threshold_minutes
                    );
                    
                    -- ุญุณุงุจ ุงูุฏูุงุฆู ุงููุนููุฉ
                    v_actual_minutes := EXTRACT(EPOCH FROM (v_last_out - v_first_in)) / 60;
                ELSE
                    v_early_leave_minutes := 0;
                    v_overtime_minutes := 0;
                    v_actual_minutes := 0;
                END IF;
                
                -- ุชุญุฏูุฏ ุงูุญุงูุฉ
                IF v_late_minutes > 0 THEN
                    v_status := 'late';
                ELSIF v_early_leave_minutes > 0 THEN
                    v_status := 'early_leave';
                ELSE
                    v_status := 'present';
                END IF;
            END IF;
            
            -- ุฅุฏุฑุงุฌ ุฃู ุชุญุฏูุซ ุณุฌู ุงูุฏูุงู
            INSERT INTO daily_attendance (
                employee_id, attendance_date, first_punch_in, last_punch_out,
                schedule_id, expected_start, expected_end,
                actual_work_minutes, expected_work_minutes,
                late_minutes, early_leave_minutes, overtime_minutes, status
            ) VALUES (
                v_employee.id, p_date, v_first_in, v_last_out,
                v_schedule.id, v_schedule.work_start_time, v_schedule.work_end_time,
                v_actual_minutes, v_expected_minutes,
                v_late_minutes, v_early_leave_minutes, v_overtime_minutes, v_status
            )
            ON CONFLICT (employee_id, attendance_date) DO UPDATE SET
                first_punch_in = EXCLUDED.first_punch_in,
                last_punch_out = EXCLUDED.last_punch_out,
                actual_work_minutes = EXCLUDED.actual_work_minutes,
                late_minutes = EXCLUDED.late_minutes,
                early_leave_minutes = EXCLUDED.early_leave_minutes,
                overtime_minutes = EXCLUDED.overtime_minutes,
                status = EXCLUDED.status,
                updated_at = NOW();
            
            v_processed := v_processed + 1;
            
        EXCEPTION WHEN OTHERS THEN
            v_errors := v_errors + 1;
            v_error_list := v_error_list || jsonb_build_object(
                'employee_id', v_employee.id,
                'error', SQLERRM
            );
        END;
    END LOOP;
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงููุนุงูุฌุฉ ูู ุงูุณุฌู ุงูุฎุงู
    UPDATE raw_attendance_log
    SET is_processed = true, processed_at = NOW()
    WHERE DATE(punch_time) = p_date AND is_processed = false;
    
    RETURN QUERY SELECT v_processed, v_errors, v_error_list;
END;
$$ LANGUAGE plpgsql;
```

## 6.8 API ุงุณุชูุจุงู ุจูุงูุงุช ุงูุจุตูุฉ

```sql
-- Function ูุงุณุชูุจุงู ุจูุงูุงุช ุงูุจุตูุฉ ูู ุงูุฃุฌูุฒุฉ
CREATE OR REPLACE FUNCTION receive_punch_data(
    p_device_code VARCHAR(50),
    p_employee_code VARCHAR(50),
    p_punch_time TIMESTAMP,
    p_punch_type VARCHAR(10),
    p_verification_type VARCHAR(20),
    p_device_log_id VARCHAR(100)
) RETURNS JSONB AS $$
DECLARE
    v_device_id UUID;
    v_employee_id UUID;
    v_log_id UUID;
BEGIN
    -- ุงูุญุตูู ุนูู ูุนุฑู ุงูุฌูุงุฒ
    SELECT id INTO v_device_id
    FROM biometric_devices
    WHERE device_code = p_device_code AND status = 'active';
    
    IF v_device_id IS NULL THEN
        RETURN jsonb_build_object('success', false, 'error', 'ุฌูุงุฒ ุบูุฑ ูุนุฑูู');
    END IF;
    
    -- ูุญุงููุฉ ูุทุงุจูุฉ ุงูููุธู
    SELECT id INTO v_employee_id
    FROM employees
    WHERE employee_code = p_employee_code;
    
    -- ุฅุฏุฑุงุฌ ุงูุณุฌู
    INSERT INTO raw_attendance_log (
        device_id, employee_code, punch_time, punch_type,
        verification_type, device_log_id, matched_employee_id
    ) VALUES (
        v_device_id, p_employee_code, p_punch_time, 
        COALESCE(p_punch_type, 'unknown')::VARCHAR,
        COALESCE(p_verification_type, 'fingerprint')::VARCHAR,
        p_device_log_id, v_employee_id
    )
    ON CONFLICT (device_id, device_log_id) DO NOTHING
    RETURNING id INTO v_log_id;
    
    -- ุชุญุฏูุซ ุขุฎุฑ ูุฒุงููุฉ ููุฌูุงุฒ
    UPDATE biometric_devices
    SET last_sync_at = NOW(), is_online = true
    WHERE id = v_device_id;
    
    RETURN jsonb_build_object(
        'success', true,
        'log_id', v_log_id,
        'employee_matched', v_employee_id IS NOT NULL
    );
END;
$$ LANGUAGE plpgsql;
```

## 6.9 ุดุงุดุฉ ููุญุฉ ุชุญูู ุงูุญุถูุฑ ูููุฏูุฑ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ ููุญุฉ ุชุญูู ุงูุญุถูุฑ - ูุญุทุฉ ุงูุดูุงู                        โ
โ                         ๐ 16/12/2024                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  ๐ฅ ุฅุฌูุงูู ุงูููุธููู: 25                                             โ   โ
โ  โ  โ ุญุงุถุฑูู: 20 (80%)    โฐ ูุชุฃุฎุฑูู: 3 (12%)    โ ุบุงุฆุจูู: 2 (8%)   โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ุญุงูุฉ ุงูููุธููู ุงูุขู                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูููุธู        โ ุงูุญุงูุฉ       โ ููุช ุงูุญุถูุฑ  โ ููุงุญุธุงุช              โ   โ
โ  โโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ ุฃุญูุฏ ูุญูุฏ     โ โ ุญุงุถุฑ     โ 07:55        โ                      โ   โ
โ  โ ูุญูุฏ ุนูู      โ โ ุญุงุถุฑ     โ 08:02        โ                      โ   โ
โ  โ ุฎุงูุฏ ุฃุญูุฏ     โ โฐ ูุชุฃุฎุฑ    โ 08:45        โ ุชุฃุฎุฑ 30 ุฏูููุฉ        โ   โ
โ  โ ุณุงูู ุนุจุฏุงููู  โ โ ุบุงุฆุจ     โ -            โ                      โ   โ
โ  โ ุนูุฑ ุญุณู       โ ๐๏ธ ุฅุฌุงุฒุฉ    โ -            โ ุฅุฌุงุฒุฉ ุณูููุฉ          โ   โ
โ  โโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ููุฎุต ุงูุฃุณุจูุน                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  ๐ ูุณุจุฉ ุงูุญุถูุฑ: โโโโโโโโโโโโโโโโโโโโ 85%                          โ   โ
โ  โ  โฐ ุฅุฌูุงูู ุงูุชุฃุฎูุฑ: 4.5 ุณุงุนุฉ                                       โ   โ
โ  โ  ๐ผ ุฅุฌูุงูู ุงูุนูู ุงูุฅุถุงูู: 12 ุณุงุนุฉ                                  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [๐ ุชูุฑูุฑ ุชูุตููู]  [๐ค ุชุตุฏูุฑ]  [โ๏ธ ุฅุนุฏุงุฏุงุช]                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 6.10 ุชูุฑูุฑ ุงูุฏูุงู ุงูุดูุฑู

```sql
CREATE OR REPLACE VIEW v_monthly_attendance_report AS
SELECT 
    e.id AS employee_id,
    e.employee_code,
    e.full_name,
    e.department,
    s.station_name,
    DATE_TRUNC('month', da.attendance_date) AS month,
    
    -- ุฅุญุตุงุฆูุงุช ุงูุญุถูุฑ
    COUNT(*) FILTER (WHERE da.status = 'present') AS present_days,
    COUNT(*) FILTER (WHERE da.status = 'absent') AS absent_days,
    COUNT(*) FILTER (WHERE da.status = 'late') AS late_days,
    COUNT(*) FILTER (WHERE da.status = 'leave') AS leave_days,
    COUNT(*) FILTER (WHERE da.status = 'holiday') AS holiday_days,
    
    -- ุฅุฌูุงูู ุงูุฏูุงุฆู
    SUM(da.actual_work_minutes) AS total_work_minutes,
    SUM(da.late_minutes) AS total_late_minutes,
    SUM(da.early_leave_minutes) AS total_early_leave_minutes,
    SUM(da.overtime_minutes) AS total_overtime_minutes,
    
    -- ุชุญููู ูุณุงุนุงุช
    ROUND(SUM(da.actual_work_minutes) / 60.0, 2) AS total_work_hours,
    ROUND(SUM(da.late_minutes) / 60.0, 2) AS total_late_hours,
    ROUND(SUM(da.overtime_minutes) / 60.0, 2) AS total_overtime_hours

FROM employees e
JOIN daily_attendance da ON da.employee_id = e.id
LEFT JOIN stations s ON s.id = e.station_id
GROUP BY e.id, e.employee_code, e.full_name, e.department, s.station_name, DATE_TRUNC('month', da.attendance_date);
```

## 6.11 ุชุตุฏูุฑ ุจูุงูุงุช ุงูุฑูุงุชุจ

```sql
CREATE OR REPLACE FUNCTION export_payroll_data(
    p_month DATE,
    p_station_id UUID DEFAULT NULL
) RETURNS TABLE (
    employee_code VARCHAR,
    employee_name VARCHAR,
    department VARCHAR,
    work_days INT,
    absent_days INT,
    late_hours DECIMAL,
    overtime_hours DECIMAL,
    late_deduction DECIMAL,
    overtime_pay DECIMAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        e.employee_code,
        e.full_name,
        e.department,
        COUNT(*) FILTER (WHERE da.status IN ('present', 'late'))::INT AS work_days,
        COUNT(*) FILTER (WHERE da.status = 'absent')::INT AS absent_days,
        ROUND(SUM(da.late_minutes) / 60.0, 2) AS late_hours,
        ROUND(SUM(da.overtime_minutes) / 60.0, 2) AS overtime_hours,
        -- ุญุณุงุจ ุงูุฎุตู (ุงูุชุฑุงุถู: 50 ุฑูุงู/ุณุงุนุฉ ุชุฃุฎูุฑ)
        ROUND(SUM(da.late_minutes) / 60.0 * 50, 2) AS late_deduction,
        -- ุญุณุงุจ ุงูุนูู ุงูุฅุถุงูู (ุงูุชุฑุงุถู: 100 ุฑูุงู/ุณุงุนุฉ)
        ROUND(SUM(da.overtime_minutes) / 60.0 * 100, 2) AS overtime_pay
    FROM employees e
    JOIN daily_attendance da ON da.employee_id = e.id
    WHERE DATE_TRUNC('month', da.attendance_date) = DATE_TRUNC('month', p_month)
    AND (p_station_id IS NULL OR e.station_id = p_station_id)
    GROUP BY e.id, e.employee_code, e.full_name, e.department;
END;
$$ LANGUAGE plpgsql;
```

## 6.12 APIs ุงูุญุถูุฑ ูุงูุงูุตุฑุงู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/attendance/punch` | ุงุณุชูุจุงู ุจูุงูุงุช ุงูุจุตูุฉ |
| GET | `/api/v1/attendance/dashboard` | ููุญุฉ ุชุญูู ุงูุญุถูุฑ |
| GET | `/api/v1/attendance/daily/:date` | ุณุฌู ุงูุญุถูุฑ ุงููููู |
| GET | `/api/v1/attendance/employee/:id` | ุณุฌู ููุธู ูุญุฏุฏ |
| GET | `/api/v1/attendance/report/monthly` | ุงูุชูุฑูุฑ ุงูุดูุฑู |
| GET | `/api/v1/attendance/export/payroll` | ุชุตุฏูุฑ ุจูุงูุงุช ุงูุฑูุงุชุจ |
| PUT | `/api/v1/attendance/:id/adjust` | ุชุนุฏูู ุณุฌู ูุฏููุงู |
| GET | `/api/v1/devices/biometric` | ูุงุฆูุฉ ุฃุฌูุฒุฉ ุงูุจุตูุฉ |
| POST | `/api/v1/devices/biometric/:id/sync` | ูุฒุงููุฉ ุฌูุงุฒ |


---

# 7. ุชูุงุฑูุฑ ุงูุชููู ูุงููุณุงูุงุช (Mobility Reports)

## 7.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุฑุจุท ุจูุงูุงุช ุชุชุจุน GPS ุจูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุฅูุชุงุฌ ุชูุงุฑูุฑ ุงูุชููู ูุญุณุงุจ ุจุฏูุงุช ุงูููุงุตูุงุช.

## 7.2 ุฌุฏูู ููุฎุต ุงูุชููู ุงููููู (daily_mobility_summary)

```sql
CREATE TABLE daily_mobility_summary (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    summary_date DATE NOT NULL,
    
    -- ุฅุญุตุงุฆูุงุช ุงููุณุงูุฉ
    total_distance_km DECIMAL(10, 2) DEFAULT 0,
    work_distance_km DECIMAL(10, 2) DEFAULT 0,     -- ุงููุณุงูุฉ ุฃุซูุงุก ุงูููุงู
    travel_distance_km DECIMAL(10, 2) DEFAULT 0,   -- ุงููุณุงูุฉ ูู ุงูุชููู
    
    -- ุฅุญุตุงุฆูุงุช ุงูููุช
    total_tracking_minutes INT DEFAULT 0,
    time_on_task_minutes INT DEFAULT 0,
    time_traveling_minutes INT DEFAULT 0,
    time_on_break_minutes INT DEFAULT 0,
    
    -- ุฅุญุตุงุฆูุงุช ุงูููุงู
    tasks_visited INT DEFAULT 0,
    unique_locations_visited INT DEFAULT 0,
    
    -- ุฃูู ูุขุฎุฑ ูููุน
    first_location_time TIMESTAMP,
    first_latitude DECIMAL(10, 8),
    first_longitude DECIMAL(11, 8),
    last_location_time TIMESTAMP,
    last_latitude DECIMAL(10, 8),
    last_longitude DECIMAL(11, 8),
    
    -- ุญุณุงุจ ุงูุจุฏูุงุช
    transportation_allowance DECIMAL(10, 2) DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, summary_date)
);

CREATE INDEX idx_mobility_employee ON daily_mobility_summary(employee_id);
CREATE INDEX idx_mobility_date ON daily_mobility_summary(summary_date);
```

## 7.3 View ุชูุฑูุฑ ุงูุชููู ุงูุดูุฑู

```sql
CREATE OR REPLACE VIEW v_monthly_mobility_report AS
SELECT 
    e.id AS employee_id,
    e.employee_code,
    e.full_name,
    e.department,
    s.station_name,
    DATE_TRUNC('month', dms.summary_date) AS month,
    
    -- ุฅุฌูุงูู ุงููุณุงูุงุช
    SUM(dms.total_distance_km) AS total_distance_km,
    AVG(dms.total_distance_km) AS avg_daily_distance_km,
    MAX(dms.total_distance_km) AS max_daily_distance_km,
    
    -- ุฅุฌูุงูู ุงูุฃููุงุช
    SUM(dms.time_traveling_minutes) / 60.0 AS total_travel_hours,
    SUM(dms.time_on_task_minutes) / 60.0 AS total_task_hours,
    
    -- ุฅุฌูุงูู ุงูููุงู
    SUM(dms.tasks_visited) AS total_tasks_visited,
    COUNT(dms.id) AS working_days,
    
    -- ุฅุฌูุงูู ุงูุจุฏูุงุช
    SUM(dms.transportation_allowance) AS total_transportation_allowance

FROM employees e
JOIN daily_mobility_summary dms ON dms.employee_id = e.id
LEFT JOIN stations s ON s.id = e.station_id
GROUP BY e.id, e.employee_code, e.full_name, e.department, s.station_name, DATE_TRUNC('month', dms.summary_date);
```

## 7.4 Function ุญุณุงุจ ุจุฏู ุงูููุงุตูุงุช

```sql
CREATE OR REPLACE FUNCTION calculate_transportation_allowance(
    p_employee_id UUID,
    p_date DATE DEFAULT CURRENT_DATE - 1
) RETURNS DECIMAL(10, 2) AS $$
DECLARE
    v_distance DECIMAL(10, 2);
    v_rate_per_km DECIMAL(6, 2) := 5.0;  -- 5 ุฑูุงู ููู ูููููุชุฑ
    v_min_allowance DECIMAL(10, 2) := 50.0;
    v_max_allowance DECIMAL(10, 2) := 500.0;
    v_allowance DECIMAL(10, 2);
BEGIN
    -- ุงูุญุตูู ุนูู ุงููุณุงูุฉ ูู ุงูููุฎุต ุงููููู
    SELECT total_distance_km INTO v_distance
    FROM daily_mobility_summary
    WHERE employee_id = p_employee_id AND summary_date = p_date;
    
    IF v_distance IS NULL THEN
        RETURN 0;
    END IF;
    
    -- ุญุณุงุจ ุงูุจุฏู
    v_allowance := v_distance * v_rate_per_km;
    
    -- ุชุทุจูู ุงูุญุฏูุฏ
    v_allowance := GREATEST(v_min_allowance, LEAST(v_max_allowance, v_allowance));
    
    -- ุชุญุฏูุซ ุงูููุฎุต
    UPDATE daily_mobility_summary
    SET transportation_allowance = v_allowance
    WHERE employee_id = p_employee_id AND summary_date = p_date;
    
    RETURN v_allowance;
END;
$$ LANGUAGE plpgsql;
```

## 7.5 ุฑุจุท ุงูุชุชุจุน ุจุงูุญุถูุฑ

```sql
-- Trigger ูุชุณุฌูู ุงูุญุถูุฑ ูู ุฃูู ูููุน
CREATE OR REPLACE FUNCTION auto_attendance_from_location()
RETURNS TRIGGER AS $$
DECLARE
    v_schedule RECORD;
    v_today DATE := CURRENT_DATE;
BEGIN
    -- ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุณุฌู ุญุถูุฑ ููุฐุง ุงูููู
    IF NOT EXISTS (
        SELECT 1 FROM daily_attendance 
        WHERE employee_id = NEW.employee_id AND attendance_date = v_today
    ) THEN
        -- ุงูุญุตูู ุนูู ุฌุฏูู ุงูุนูู
        SELECT ws.* INTO v_schedule
        FROM employee_schedules es
        JOIN work_schedules ws ON ws.id = es.schedule_id
        WHERE es.employee_id = NEW.employee_id AND es.is_current = true;
        
        -- ุฅูุดุงุก ุณุฌู ุญุถูุฑ ุฃููู
        INSERT INTO daily_attendance (
            employee_id, attendance_date, first_punch_in,
            schedule_id, expected_start, expected_end, status
        ) VALUES (
            NEW.employee_id, v_today, NEW.recorded_at,
            v_schedule.id, v_schedule.work_start_time, v_schedule.work_end_time,
            CASE 
                WHEN NEW.recorded_at::TIME > v_schedule.work_start_time + (v_schedule.late_grace_minutes || ' minutes')::INTERVAL 
                THEN 'late' 
                ELSE 'present' 
            END
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auto_attendance_from_location
AFTER INSERT ON location_tracking_log
FOR EACH ROW
EXECUTE FUNCTION auto_attendance_from_location();
```


---

# ๐ ุงูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ (02)

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ ุนุจุฑ:
1. **APIs ุงูุฏุงุฎููุฉ** - ููุชูุงุตู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู
2. **ูุธุงู ุงูุฃุญุฏุงุซ** - ููุดุฑ ุฃุญุฏุงุซ ุงูููุธููู ูุงูุฑูุงุชุจ
3. **ุชูุงูู ุฃุฌูุฒุฉ ุงูุจุตูุฉ** - ูุงุณุชูุจุงู ุจูุงูุงุช ุงูุญุถูุฑ
4. **ุจูุงุจุฉ ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ** - ููููุธููู

---

## ๐ก APIs ุงููุณุฌูุฉ ูู ูุธุงู ุงููุทูุฑ

ุฌููุน APIs ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุชุงุญุฉ ุนุจุฑ `/api/hr/*`:

| ุงููุฌููุนุฉ | Endpoint | ุงููุตู |
|----------|----------|-------|
| ุงูููุธููู | `/api/hr/employees` | ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูููุธููู |
| ุงูุญุถูุฑ | `/api/hr/attendance` | ุฅุฏุงุฑุฉ ุงูุญุถูุฑ ูุงูุงูุตุฑุงู |
| ุงูุฑูุงุชุจ | `/api/hr/payroll` | ุฅุฏุงุฑุฉ ูุณูุฑุงุช ุงูุฑูุงุชุจ |
| ุงูุฅุฌุงุฒุงุช | `/api/hr/leaves` | ุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุฅุฌุงุฒุงุช |
| ุงูุฃุฌูุฒุฉ | `/api/hr/devices` | ุฅุฏุงุฑุฉ ุฃุฌูุฒุฉ ุงูุจุตูุฉ |

---

## ๐ฏ ุงูุฃุญุฏุงุซ ุงูููุดูุฑุฉ

ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ููุดุฑ ุงูุฃุญุฏุงุซ ุงูุชุงููุฉ:

```
employee.created            - ุฅูุดุงุก ููุธู ุฌุฏูุฏ
employee.updated            - ุชุญุฏูุซ ุจูุงูุงุช ููุธู
employee.terminated         - ุฅููุงุก ุฎุฏูุฉ ููุธู

attendance.checked_in       - ุชุณุฌูู ุญุถูุฑ
attendance.checked_out      - ุชุณุฌูู ุงูุตุฑุงู
attendance.late             - ุชุฃุฎุฑ ููุธู

payroll.calculated          - ุญุณุงุจ ุงูุฑูุงุชุจ
payroll.approved            - ุงุนุชูุงุฏ ูุณูุฑ ุงูุฑูุงุชุจ
payroll.paid                - ุตุฑู ุงูุฑูุงุชุจ

leave.requested             - ุทูุจ ุฅุฌุงุฒุฉ
leave.approved              - ุงูููุงููุฉ ุนูู ุฅุฌุงุฒุฉ
leave.rejected              - ุฑูุถ ุฅุฌุงุฒุฉ
```

---

## ๐ฅ ุงูุฃุญุฏุงุซ ุงููุณุชูุจูุฉ

| ุงูุญุฏุซ | ุงููุตุฏุฑ | ุงูุฅุฌุฑุงุก |
|-------|--------|---------|
| `work_order.completed` | ุงูุนูููุงุช ุงูููุฏุงููุฉ | ุญุณุงุจ ุญูุงูุฒ ุงูููููู |
| `user.created` | ุงููุธุงู ุงูุฃู | ุฅูุดุงุก ุณุฌู ููุธู |
| `finance.period_closed` | ุงููุธุงู ุงููุงูู | ุฅุบูุงู ูุชุฑุฉ ุงูุฑูุงุชุจ |

---

## ๐ง ุชูุงูู ุฃุฌูุฒุฉ ุงูุจุตูุฉ

### Webhook ูุงุณุชูุจุงู ุจูุงูุงุช ุงูุจุตูุฉ

```
POST /api/hr/attendance/punch
```

### ูููู ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ

```json
{
  "device_id": "BIO-001",
  "device_type": "zkteco",
  "employee_code": "EMP001",
  "punch_time": "2024-12-15T08:00:00Z",
  "punch_type": "in",
  "verification_type": "fingerprint"
}
```

---

## ๐ค ุจูุงุจุฉ ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ

### APIs ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ (`/api/hr/self-service/*`)

```
GET    /api/hr/self-service/profile         - ุจูุงูุงุชู
GET    /api/hr/self-service/attendance      - ุณุฌู ุญุถูุฑู
GET    /api/hr/self-service/leaves          - ุทูุจุงุช ุฅุฌุงุฒุงุชู
POST   /api/hr/self-service/leaves          - ุชูุฏูู ุทูุจ ุฅุฌุงุฒุฉ
GET    /api/hr/self-service/payslips        - ูุณุงุฆู ุฑูุงุชุจู
GET    /api/hr/self-service/custodies       - ุนูุฏู
```

---

## ๐ ููุงููุณ ุงูุฃุฏุงุก ุงููุฑุณูุฉ ููุธุงู ุงููุทูุฑ

```sql
INSERT INTO performance_metrics (metric_name, metric_type, metric_value, labels)
VALUES
  ('hr.total_employees', 'gauge', 150, '{}'),
  ('hr.attendance_rate', 'gauge', 95.5, '{}'),
  ('hr.late_arrivals_today', 'counter', 5, '{}'),
  ('hr.pending_leave_requests', 'gauge', 12, '{}');
```


---

# ๐ฑ ุงูุดุงุดุงุช ูุงููุงุฌูุงุช ุงูุชูุตูููุฉ

## 1. ููุญุฉ ุชุญูู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ (HR Dashboard)

### ููููุงุช ุงูุดุงุดุฉ:
| ุงููููู | ุงููุตู |
|--------|-------|
| ุฅุญุตุงุฆูุงุช ุงูููุธููู | ุงูุนุฏุฏ ุงูุฅุฌูุงููุ ุงููุดุทููุ ูู ุฅุฌุงุฒุฉ |
| ุงูุญุถูุฑ ุงููููู | ูุณุจุฉ ุงูุญุถูุฑุ ุงููุชุฃุฎุฑููุ ุงูุบุงุฆุจูู |
| ุงูุฅุฌุงุฒุงุช ุงููุนููุฉ | ุทูุจุงุช ุชุญุชุงุฌ ููุงููุฉ |
| ุฃุนูุงุฏ ุงููููุงุฏ | ุงูููุธููู ูุฐุง ุงูุดูุฑ |
| ุงูุชูุงุก ุงูุนููุฏ | ุนููุฏ ุชูุชูู ุฎูุงู 30 ููู |

---

## 2. ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูููุธููู (Employee Management)

### ููููุงุช ุงูุดุงุดุฉ:
| ุงููููู | ุงููุตู |
|--------|-------|
| ูุงุฆูุฉ ุงูููุธููู | ุฌุฏูู ูุน ุงูุจุญุซ ูุงูููุชุฑุฉ |
| ุจุทุงูุฉ ุงูููุธู | ุงูุตูุฑุฉ ูุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ |
| ุงูุชุจููุจุงุช | ุดุฎุตูุ ูุธูููุ ูุงููุ ูุณุชูุฏุงุช |

### ุงูุญููู:
**ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ:**
- ุงูุงุณู ุงููุงูู (ูุทููุจ)
- ุฑูู ุงููููุฉ (ูุทููุจุ ูุฑูุฏ)
- ุชุงุฑูุฎ ุงููููุงุฏ (ูุทููุจ)
- ุงูุฌูุณ (ูุทููุจ)
- ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ
- ุงูุนููุงู
- ุฑูู ุงููุงุชู (ูุทููุจ)
- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- ุฌูุฉ ุงูุงุชุตุงู ููุทูุงุฑุฆ

**ุงูุจูุงูุงุช ุงููุธูููุฉ:**
- ุงูุฑูู ุงููุธููู (ุชููุงุฆูุ ูุฑูุฏ)
- ุงููุณูู ุงููุธููู (ูุทููุจ)
- ุงููุณู (ูุทููุจ)
- ุงููุญุทุฉ (ูุทููุจ)
- ุชุงุฑูุฎ ุงูุชุนููู (ูุทููุจ)
- ููุน ุงูุนูุฏ (ุฏุงุฆู/ูุคูุช/ูุชุนุงูุฏ)
- ุชุงุฑูุฎ ุงูุชูุงุก ุงูุนูุฏ
- ุงููุฏูุฑ ุงููุจุงุดุฑ

**ุงูุจูุงูุงุช ุงููุงููุฉ:**
- ุงูุฑุงุชุจ ุงูุฃุณุงุณู (ูุทููุจ)
- ุจุฏู ุงูุณูู
- ุจุฏู ุงูููุงุตูุงุช
- ุจุฏูุงุช ุฃุฎุฑู
- ุฑูู ุงูุญุณุงุจ ุงูุจููู
- ุงุณู ุงูุจูู

---

## 3. ุดุงุดุฉ ุงูุญุถูุฑ ูุงูุงูุตุฑุงู (Attendance)

### ููููุงุช ุงูุดุงุดุฉ:
| ุงููููู | ุงููุตู |
|--------|-------|
| ุงูุชูููู | ุนุฑุถ ุดูุฑู ููุญุถูุฑ |
| ุณุฌู ุงูููู | ุงูุญุถูุฑ ูุงูุงูุตุฑุงู |
| ุงูุชุฃุฎูุฑุงุช | ูุงุฆูุฉ ุงููุชุฃุฎุฑูู |
| ุงูุบูุงุจ | ูุงุฆูุฉ ุงูุบุงุฆุจูู |

### ุงูุฅุฌุฑุงุกุงุช:
- ุชุณุฌูู ุญุถูุฑ ูุฏูู
- ุชุนุฏูู ุณุฌู ุงูุญุถูุฑ
- ุฅุถุงูุฉ ุนุฐุฑ ุบูุงุจ
- ุชุตุฏูุฑ ุงูุชูุฑูุฑ

---

## 4. ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุฅุฌุงุฒุงุช (Leave Management)

### ููููุงุช ุงูุดุงุดุฉ:
| ุงููููู | ุงููุตู |
|--------|-------|
| ุทูุจุงุช ูุนููุฉ | ุชุญุชุงุฌ ููุงููุฉ |
| ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช | ููู ููุธู |
| ุชูููู ุงูุฅุฌุงุฒุงุช | ุนุฑุถ ุดูุฑู |

### ุฃููุงุน ุงูุฅุฌุงุฒุงุช:
| ุงูููุน | ุงูุฑุตูุฏ ุงูุณููู | ูุงุจู ููุชุฑุญูู |
|-------|--------------|--------------|
| ุณูููุฉ | 30 ููู | ูุนู (ุญุฏ 15) |
| ูุฑุถูุฉ | 30 ููู | ูุง |
| ุทุงุฑุฆุฉ | 7 ุฃูุงู | ูุง |
| ุฒูุงุฌ | 5 ุฃูุงู | ูุง |
| ููุงุฉ ูุฑูุจ | 3 ุฃูุงู | ูุง |
| ุฃูููุฉ | 90 ููู | ูุง |
| ุฃุจูุฉ | 3 ุฃูุงู | ูุง |

---

## 5. ุดุงุดุฉ ูุณูุฑ ุงูุฑูุงุชุจ (Payroll)

### ููููุงุช ุงูุดุงุดุฉ:
| ุงููููู | ุงููุตู |
|--------|-------|
| ุงุฎุชูุงุฑ ุงูุดูุฑ | ุงูุดูุฑ ูุงูุณูุฉ |
| ูุงุฆูุฉ ุงูููุธููู | ูุน ุงูุงุณุชุญูุงูุงุช ูุงูุฎุตููุงุช |
| ููุฎุต ุงููุณูุฑ | ุฅุฌูุงูู ุงูุฑูุงุชุจ |
| ุญุงูุฉ ุงููุณูุฑ | ูุณูุฏุฉ/ูุนุชูุฏ/ูุฏููุน |

### ุนูุงุตุฑ ุงูุฑุงุชุจ:
**ุงูุงุณุชุญูุงูุงุช:**
- ุงูุฑุงุชุจ ุงูุฃุณุงุณู
- ุจุฏู ุงูุณูู
- ุจุฏู ุงูููุงุตูุงุช
- ุจุฏูุงุช ุฃุฎุฑู
- ุงูุนูู ุงูุฅุถุงูู
- ุงูููุงูุขุช

**ุงูุฎุตููุงุช:**
- ุงูุณูู
- ุงูุบูุงุจ
- ุงูุชุฃุฎูุฑ
- ุงูุชุฃูููุงุช (ุญุตุฉ ุงูููุธู)
- ุถุฑูุจุฉ ุงูุฏุฎู

---

## 6. ุดุงุดุฉ ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ ููููุธู (Employee Self-Service)

### ููููุงุช ุงูุดุงุดุฉ:
| ุงููููู | ุงููุตู |
|--------|-------|
| ุจูุงูุงุชู | ุนุฑุถ ูุชุนุฏูู ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ |
| ุญุถูุฑู | ุณุฌู ุงูุญุถูุฑ ูุงูุงูุตุฑุงู |
| ุฅุฌุงุฒุงุชู | ุงูุฑุตูุฏ ูุงูุทูุจุงุช |
| ุฑุงุชุจู | ูุดู ุงูุฑุงุชุจ ุงูุดูุฑู |
| ุทูุจุงุชู | ุทูุจุงุช ูุนููุฉ ููุนุงูุฌุฉ |

### ุงูุทูุจุงุช ุงููุชุงุญุฉ:
- ุทูุจ ุฅุฌุงุฒุฉ
- ุทูุจ ุณููุฉ
- ุทูุจ ุดูุงุฏุฉ ุฎุจุฑุฉ
- ุทูุจ ุชุนุฏูู ุจูุงูุงุช
- ุทูุจ ุจุฏู ุนูู ุฅุถุงูู

---

# โ๏ธ ููุงุนุฏ ุงูุนูู (Business Rules)

## ููุงุนุฏ ุงูุญุถูุฑ

| ุงููุงุนุฏุฉ | ุงููุตู |
|---------|-------|
| BR-HR-001 | ุงูุชุฃุฎูุฑ > 15 ุฏูููุฉ = ุฎุตู ุฑุจุน ููู |
| BR-HR-002 | ุงูุชุฃุฎูุฑ > 30 ุฏูููุฉ = ุฎุตู ูุตู ููู |
| BR-HR-003 | ุงูุบูุงุจ ุจุฏูู ุนุฐุฑ = ุฎุตู ููู ูุงูู |
| BR-HR-004 | 3 ุชุฃุฎูุฑุงุช = ุฅูุฐุงุฑ ุดููู |
| BR-HR-005 | 5 ุชุฃุฎูุฑุงุช = ุฅูุฐุงุฑ ูุชุงุจู |

## ููุงุนุฏ ุงูุฅุฌุงุฒุงุช

| ุงููุงุนุฏุฉ | ุงููุตู |
|---------|-------|
| BR-LV-001 | ุทูุจ ุงูุฅุฌุงุฒุฉ ูุจู 3 ุฃูุงู ุนูู ุงูุฃูู |
| BR-LV-002 | ูุง ูููู ุทูุจ ุฅุฌุงุฒุฉ ุฃุซูุงุก ูุชุฑุฉ ุงูุงุฎุชุจุงุฑ |
| BR-LV-003 | ุงูุญุฏ ุงูุฃูุตู ููุฅุฌุงุฒุฉ ุงููุชุตูุฉ 15 ููู |
| BR-LV-004 | ููุงููุฉ ุงููุฏูุฑ ุงููุจุงุดุฑ ูุทููุจุฉ |
| BR-LV-005 | ุงูุฅุฌุงุฒุฉ ุงููุฑุถูุฉ ุชุชุทูุจ ุชูุฑูุฑ ุทุจู |

## ููุงุนุฏ ุงูุฑูุงุชุจ

| ุงููุงุนุฏุฉ | ุงููุตู |
|---------|-------|
| BR-PAY-001 | ุตุฑู ุงูุฑูุงุชุจ ููู 25 ูู ูู ุดูุฑ |
| BR-PAY-002 | ุฎุตู ุงูุณููุฉ ูู ุงูุฑุงุชุจ ุชููุงุฆูุงู |
| BR-PAY-003 | ุญุฏ ุงูุณููุฉ = ุฑุงุชุจ ุดูุฑ ูุงุญุฏ |
| BR-PAY-004 | ุงูุนูู ุงูุฅุถุงูู = 1.5x ุงูุฑุงุชุจ ุงูุณุงุนู |
| BR-PAY-005 | ุงูุนูู ูู ุงูุนุทู = 2x ุงูุฑุงุชุจ ุงูุณุงุนู |

---

# ๐ ููุงุนุฏ ุงูุชุญูู (Validation Rules)

```sql
-- ุงูุชุญูู ูู ุทูุจ ุงูุฅุฌุงุฒุฉ
CREATE OR REPLACE FUNCTION validate_leave_request()
RETURNS TRIGGER AS $$
DECLARE
    available_balance INT;
    days_requested INT;
BEGIN
    -- ุญุณุงุจ ุนุฏุฏ ุงูุฃูุงู ุงููุทููุจุฉ
    days_requested := NEW.end_date - NEW.start_date + 1;
    
    -- ุงูุชุญูู ูู ุงูุฑุตูุฏ
    SELECT balance INTO available_balance
    FROM leave_balances
    WHERE employee_id = NEW.employee_id
    AND leave_type = NEW.leave_type;
    
    IF days_requested > available_balance THEN
        RAISE EXCEPTION 'ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช ุบูุฑ ูุงูู. ุงููุชุงุญ: % ุฃูุงู', available_balance;
    END IF;
    
    -- ุงูุชุญูู ูู ุชุงุฑูุฎ ุงูุทูุจ
    IF NEW.start_date < CURRENT_DATE + INTERVAL '3 days' 
       AND NEW.leave_type = 'annual' THEN
        RAISE EXCEPTION 'ูุฌุจ ุชูุฏูู ุทูุจ ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ ูุจู 3 ุฃูุงู ุนูู ุงูุฃูู';
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ุงูุชุญูู ูู ุทูุจ ุงูุณููุฉ
CREATE OR REPLACE FUNCTION validate_advance_request()
RETURNS TRIGGER AS $$
DECLARE
    monthly_salary DECIMAL;
    pending_advances DECIMAL;
BEGIN
    -- ุงูุญุตูู ุนูู ุงูุฑุงุชุจ ุงูุดูุฑู
    SELECT basic_salary INTO monthly_salary
    FROM employees
    WHERE id = NEW.employee_id;
    
    -- ุงูุญุตูู ุนูู ุงูุณูู ุงููุนููุฉ
    SELECT COALESCE(SUM(remaining_amount), 0) INTO pending_advances
    FROM salary_advances
    WHERE employee_id = NEW.employee_id
    AND status = 'active';
    
    -- ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃูุตู
    IF NEW.amount + pending_advances > monthly_salary THEN
        RAISE EXCEPTION 'ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุณูู. ุงูุญุฏ: % ุฑูุงู', monthly_salary;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

# ๐ก APIs ุฅุถุงููุฉ

## ุฅุฏุงุฑุฉ ุงูููุธููู

```
GET    /api/hr/employees                    - ูุงุฆูุฉ ุงูููุธููู
GET    /api/hr/employees/:id                - ุชูุงุตูู ููุธู
POST   /api/hr/employees                    - ุฅุถุงูุฉ ููุธู
PUT    /api/hr/employees/:id                - ุชุนุฏูู ููุธู
DELETE /api/hr/employees/:id                - ุญุฐู ููุธู
GET    /api/hr/employees/:id/documents      - ูุณุชูุฏุงุช ุงูููุธู
POST   /api/hr/employees/:id/documents      - ุฑูุน ูุณุชูุฏ
```

## ุงูุญุถูุฑ ูุงูุงูุตุฑุงู

```
GET    /api/hr/attendance                   - ุณุฌู ุงูุญุถูุฑ
POST   /api/hr/attendance/check-in          - ุชุณุฌูู ุญุถูุฑ
POST   /api/hr/attendance/check-out         - ุชุณุฌูู ุงูุตุฑุงู
GET    /api/hr/attendance/report            - ุชูุฑูุฑ ุงูุญุถูุฑ
POST   /api/hr/attendance/import            - ุงุณุชูุฑุงุฏ ูู ุงูุจุตูุฉ
```

## ุงูุฅุฌุงุฒุงุช

```
GET    /api/hr/leaves                       - ูุงุฆูุฉ ุงูุฅุฌุงุฒุงุช
POST   /api/hr/leaves                       - ุทูุจ ุฅุฌุงุฒุฉ
PUT    /api/hr/leaves/:id/approve           - ููุงููุฉ ุนูู ุฅุฌุงุฒุฉ
PUT    /api/hr/leaves/:id/reject            - ุฑูุถ ุฅุฌุงุฒุฉ
GET    /api/hr/leaves/balances/:employee_id - ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช
```

## ุงูุฑูุงุชุจ

```
GET    /api/hr/payroll/:year/:month         - ูุณูุฑ ุงูุฑูุงุชุจ
POST   /api/hr/payroll/:year/:month/calculate - ุญุณุงุจ ุงูุฑูุงุชุจ
PUT    /api/hr/payroll/:year/:month/approve - ุงุนุชูุงุฏ ุงููุณูุฑ
POST   /api/hr/payroll/:year/:month/pay     - ุตุฑู ุงูุฑูุงุชุจ
GET    /api/hr/payslip/:employee_id/:year/:month - ูุดู ุฑุงุชุจ
```

## ุงูุณูู

```
GET    /api/hr/advances                     - ูุงุฆูุฉ ุงูุณูู
POST   /api/hr/advances                     - ุทูุจ ุณููุฉ
PUT    /api/hr/advances/:id/approve         - ููุงููุฉ ุนูู ุณููุฉ
GET    /api/hr/advances/:employee_id        - ุณูู ููุธู
```

## ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ

```
GET    /api/hr/self-service/profile         - ุจูุงูุงุชู
PUT    /api/hr/self-service/profile         - ุชุนุฏูู ุจูุงูุงุชู
GET    /api/hr/self-service/attendance      - ุญุถูุฑู
GET    /api/hr/self-service/leaves          - ุฅุฌุงุฒุงุชู
GET    /api/hr/self-service/payslips        - ุฑูุงุชุจู
POST   /api/hr/self-service/requests        - ุชูุฏูู ุทูุจ
```


---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ ูููุธุงู

### ูุนูููุงุช ุงููุณุชูุฏุน

| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงุณู ุงููุณุชูุฏุน** | `hr-system` |
| **ุงููููุฐ API** | 3008 |
| **ุงููููุฐ Web** | 4208 |
| **ุจุงุฏุฆุฉ ุงูุฌุฏุงูู** | `hr_` |
| **ูุณุงุฑ API** | `/api/v1/hr` |

### Prisma Schema ุงูุฃุณุงุณู

```prisma
model hr_employees {
  id              String    @id @default(uuid()) @db.Uuid
  employeeNumber  String    @unique @map("employee_number") @db.VarChar(20)
  userId          String?   @map("user_id") @db.Uuid
  firstName       String    @map("first_name") @db.VarChar(100)
  lastName        String    @map("last_name") @db.VarChar(100)
  idNumber        String?   @map("id_number") @db.VarChar(20)
  dateOfBirth     DateTime? @map("date_of_birth") @db.Date
  gender          String?   @db.VarChar(10)
  phone           String?   @db.VarChar(20)
  email           String?   @db.VarChar(255)
  address         String?   @db.Text
  departmentId    String    @map("department_id") @db.Uuid
  positionId      String    @map("position_id") @db.Uuid
  managerId       String?   @map("manager_id") @db.Uuid
  hireDate        DateTime  @map("hire_date") @db.Date
  terminationDate DateTime? @map("termination_date") @db.Date
  status          String    @default("active") @db.VarChar(20)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  department      hr_departments @relation(fields: [departmentId], references: [id])
  position        hr_positions @relation(fields: [positionId], references: [id])
  attendance      hr_attendance[]
  leaves          hr_leaves[]
  salaryRecords   hr_salary_records[]
  
  @@index([departmentId])
  @@index([status])
  @@map("hr_employees")
}

model hr_departments {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  parentId    String?  @map("parent_id") @db.Uuid
  managerId   String?  @map("manager_id") @db.Uuid
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  
  parent      hr_departments?  @relation("DeptHierarchy", fields: [parentId], references: [id])
  children    hr_departments[] @relation("DeptHierarchy")
  employees   hr_employees[]
  
  @@map("hr_departments")
}

model hr_positions {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  grade       String?  @db.VarChar(20)
  minSalary   Decimal? @map("min_salary") @db.Decimal(15, 2)
  maxSalary   Decimal? @map("max_salary") @db.Decimal(15, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  
  employees   hr_employees[]
  
  @@map("hr_positions")
}

model hr_attendance {
  id          String    @id @default(uuid()) @db.Uuid
  employeeId  String    @map("employee_id") @db.Uuid
  date        DateTime  @db.Date
  checkIn     DateTime? @map("check_in")
  checkOut    DateTime? @map("check_out")
  status      String    @default("present") @db.VarChar(20)
  workHours   Decimal?  @map("work_hours") @db.Decimal(5, 2)
  overtimeHours Decimal? @map("overtime_hours") @db.Decimal(5, 2)
  notes       String?   @db.Text
  source      String    @default("manual") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at")
  
  employee    hr_employees @relation(fields: [employeeId], references: [id])
  
  @@unique([employeeId, date])
  @@map("hr_attendance")
}

model hr_leaves {
  id          String    @id @default(uuid()) @db.Uuid
  employeeId  String    @map("employee_id") @db.Uuid
  leaveTypeId String    @map("leave_type_id") @db.Uuid
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime  @map("end_date") @db.Date
  days        Int
  reason      String?   @db.Text
  status      String    @default("pending") @db.VarChar(20)
  approvedBy  String?   @map("approved_by") @db.Uuid
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  employee    hr_employees @relation(fields: [employeeId], references: [id])
  leaveType   hr_leave_types @relation(fields: [leaveTypeId], references: [id])
  
  @@map("hr_leaves")
}

model hr_leave_types {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  daysPerYear Int      @map("days_per_year")
  isPaid      Boolean  @default(true) @map("is_paid")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  
  leaves      hr_leaves[]
  
  @@map("hr_leave_types")
}

model hr_salary_records {
  id            String   @id @default(uuid()) @db.Uuid
  employeeId    String   @map("employee_id") @db.Uuid
  period        String   @db.VarChar(7)
  basicSalary   Decimal  @map("basic_salary") @db.Decimal(15, 2)
  allowances    Decimal  @default(0) @db.Decimal(15, 2)
  deductions    Decimal  @default(0) @db.Decimal(15, 2)
  overtime      Decimal  @default(0) @db.Decimal(15, 2)
  netSalary     Decimal  @map("net_salary") @db.Decimal(15, 2)
  status        String   @default("draft") @db.VarChar(20)
  paidAt        DateTime? @map("paid_at")
  createdAt     DateTime @default(now()) @map("created_at")
  
  employee      hr_employees @relation(fields: [employeeId], references: [id])
  
  @@unique([employeeId, period])
  @@map("hr_salary_records")
}

model hr_payroll_runs {
  id          String   @id @default(uuid()) @db.Uuid
  period      String   @db.VarChar(7)
  status      String   @default("draft") @db.VarChar(20)
  totalBasic  Decimal  @map("total_basic") @db.Decimal(15, 2)
  totalAllowances Decimal @map("total_allowances") @db.Decimal(15, 2)
  totalDeductions Decimal @map("total_deductions") @db.Decimal(15, 2)
  totalNet    Decimal  @map("total_net") @db.Decimal(15, 2)
  employeeCount Int     @map("employee_count")
  runBy       String   @map("run_by") @db.Uuid
  runAt       DateTime @map("run_at")
  approvedBy  String?  @map("approved_by") @db.Uuid
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@unique([period])
  @@map("hr_payroll_runs")
}
```

### Environment Variables

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/electricity_management"
JWT_SECRET="hr-system-secret-key"
API_PORT=3008
CORE_API_URL="http://localhost:3001/api/v1"
```
